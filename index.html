<!DOCTYPE html>

<html class="scroll-smooth" lang="hu">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Fishpond Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&amp;display=swap" rel="stylesheet"/>
<style>
    :root{
      --c-navy:  #14233C; --c-turq:  #54BFB2; --c-cream: #E1EACC; --c-gold:  #E4C157; --c-red:   #F24F4B; --c-blue: #6366f1;
      --text: #0f172a; --muted: #475569; --card: rgba(255,255,255,0.78); --border: rgba(20,35,60,0.08);
      --bg: linear-gradient(180deg, #ffffff 0%, #F5F7FB 100%);
    }
    .dark:root{
      --text: #eef2f6; --muted: #cbd5e1; --card: rgba(20,35,60,0.72); --border: rgba(255,255,255,0.08);
      --bg: linear-gradient(180deg, #0E192C 0%, #14233C 100%);
    }
    body {
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: var(--bg); color: var(--text); min-height: 100dvh;
    }
    body::before{
      content:""; position:fixed; inset:0; pointer-events:none; z-index:0;
      background:
        radial-gradient(900px 600px at 10% -10%, rgba(84,191,178,0.10), transparent 60%),
        radial-gradient(800px 500px at 95% 0%, rgba(225,234,204,0.20), transparent 55%);
    }
    .card-glass { background: var(--card); backdrop-filter: saturate(140%) blur(10px); border: 1px solid var(--border); }
    .card-hover { transition: transform .18s ease, box-shadow .2s ease; }
    .card-hover:hover { transform: translateY(-2px); box-shadow: 0 18px 36px rgba(20,35,60,0.10); }
    .number-display { font-size: 1.8rem; line-height: 1; letter-spacing: -0.02em; }
    .modal { transition: opacity 0.24s ease; }
    .modal-body { max-height: 80vh; overflow-y:auto; }
    .sustainability-table-container { max-height: 420px; overflow-y:auto; }
    .btn-disabled { opacity: .6; pointer-events:none; }
    .btn-primary { background: var(--c-turq); color: #0b1a2c; } .btn-primary:hover { filter: brightness(1.05); }
    .btn-secondary { background: var(--c-gold); color: #1a1200; } .btn-secondary:hover { filter: brightness(1.05); }
    .btn-danger { background: var(--c-red); color: #fff; } .btn-danger:hover { filter: brightness(1.05); }
    .btn-random { background: var(--c-blue); color: #fff; } .btn-random:hover { filter: brightness(1.05); }
    .tag-muted { background: rgba(225,234,204,0.6); color: #384152; }
    .dark .tag-muted { background: rgba(225,234,204,0.18); color: var(--muted); }
    .table-head { background: rgba(225,234,204,0.65); }
    .dark .table-head { background: rgba(225,234,204,0.12); }
    @keyframes pulse-warning { 0%, 100% { box-shadow: 0 0 0 0 rgba(242, 79, 75, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(242, 79, 75, 0); } }
    .card-warning { animation: pulse-warning 2s infinite; border-color: var(--c-red); }
    @keyframes pulse-highlight { 0%, 100% { box-shadow: 0 0 0 0 rgba(84, 191, 178, 0.5); } 70% { box-shadow: 0 0 0 8px rgba(84, 191, 178, 0); } }
    .card-highlight-active { animation: pulse-highlight 2.5s infinite; }
    .modal-type-good { border: 2px solid var(--c-turq); } .modal-type-bad { border: 2px solid var(--c-red); } .modal-type-neutral { border: 1px solid var(--border); }
    #flash-overlay { position: fixed; inset: 0; z-index: 9999; background-color: var(--c-turq); opacity: 0; pointer-events: none; transition: opacity 0.1s ease-out; }
    #flash-overlay.active { opacity: 0.25; }
    #log-panel { position: fixed; top: 0; right: 0; bottom: 0; width: 380px; max-width: 90vw; background: var(--card); backdrop-filter: blur(16px); border-left: 1px solid var(--border); transform: translateX(100%); transition: transform 0.3s ease-in-out; z-index: 60; }
    #log-panel.open { transform: translateX(0); box-shadow: -10px 0 30px rgba(20,35,60,0.15); }
    .log-entry-note { font-size: 0.8rem; background: rgba(225,234,204,0.4); border: 1px solid var(--border); color: var(--text); }
    .log-entry-detail { margin-left: 1.5rem; font-size: 0.8rem; opacity: 0.8; }
    .health-bar-bg { background-color: rgba(20,35,60,0.08); }
    .dark .health-bar-bg { background-color: rgba(255,255,255,0.08); }
    #pond-health-bar-inner { transition: width 0.4s ease-in-out, background-color 0.4s ease; }
    .advisor-card blockquote { border-left: 3px solid var(--c-turq); padding-left: 0.75rem; font-style: italic; color: var(--muted); }
    #audit-log-modal { z-index: 70; }
    .audit-table { font-size: 0.8rem; }
    .audit-table th, .audit-table td { padding: 6px 8px; border: 1px solid var(--border); }
    .audit-table .round-summary-row { background-color: rgba(84,191,178,0.15); font-weight: bold; }
    .audit-table .player-summary-row { background-color: rgba(228, 193, 87, 0.18); font-weight: bold; }
    #toast-container { position: fixed; bottom: 1rem; right: 1rem; z-index: 9999; display: flex; flex-direction: column; gap: 0.5rem; }
    .toast { background-color: var(--c-navy); color: #fff; padding: 0.75rem 1.25rem; border-radius: 0.75rem; box-shadow: 0 10px 25px rgba(20,35,60,0.2); transform: translateX(120%); opacity: 0; transition: transform 0.4s ease-in-out, opacity 0.3s ease; }
    .toast.show { transform: translateX(0); opacity: 1; }
    .dark h1.tracking-tight { background: linear-gradient(90deg, var(--text), var(--c-turq)); }
    
    #active-effects-panel details { background: rgba(20,35,60,0.03); border: 1px solid var(--border); border-radius: 0.75rem; }
    #active-effects-panel summary { padding: 0.5rem 0.75rem; font-weight: 600; cursor: pointer; }
    #active-effects-panel summary:hover { background: rgba(20,35,60,0.05); }
    #active-effects-panel .effects-group-content { padding: 0.5rem 0.75rem 0.75rem 0.75rem; }
    #active-effects-panel .effects-group-content .effect-card {
        background: var(--card); border-left: 4px solid var(--muted);
        padding: 0.75rem; border-radius: 0.5rem; display: flex; align-items: flex-start; gap: 0.75rem;
    }
    #active-effects-panel .effect-card .icon { font-size: 1.25rem; padding-top: 0.125rem; }
    #active-effects-panel .effect-card .content h4 { font-weight: 700; font-size: 0.875rem; line-height: 1.2; }
    #active-effects-panel .effect-card .content h4 span { font-size: 0.75rem; font-weight: 500; opacity: 0.8; }
    #active-effects-panel .effect-card .content .desc { font-size: 0.75rem; color: var(--muted); line-height: 1.3; }
    #active-effects-panel .effect-card .content .targets { font-size: 0.75rem; font-weight: 600; opacity: 0.9; margin-top: 2px; }
    #active-effects-panel .effect-card .content .outcome { font-size: 0.75rem; font-weight: 600; margin-top: 2px; }
    #active-effects-panel .effect-card .content .details { font-size: 0.7rem; color: var(--muted); margin-top: 4px; }
    #active-effects-panel .effect-card.status-pending { border-color: var(--c-blue); }
    #active-effects-panel .effect-card.status-active { opacity: 1; }
    #active-effects-panel .effect-card.status-expired { opacity: 0.65; }
    .dark #active-effects-panel details { background: rgba(225,234,204,0.03); }
    .dark #active-effects-panel summary:hover { background: rgba(225,234,204,0.05); }

    input.player-catch-input.bankruptcy-warning {
      border-color: var(--c-red) !important;
      box-shadow: 0 0 0 2px rgba(242, 79, 75, 0.4);
    }
    
    /* === v8.7 "PIL√ìTAF√úLKE" UI ST√çLUSOK === */
    
    /* A f≈ë elrendez√©s: 40% ir√°ny√≠t√°s, 60% st√°tusz */
    #cockpit-grid {
      display: grid;
      grid-template-columns: 40% 1fr;
      gap: 2rem;
    }
    /* Kisebb k√©perny≈ën egym√°s al√° ker√ºlnek */
    @media (max-width: 1024px) {
      #cockpit-grid {
        grid-template-columns: 1fr;
      }
    }
    
    /* St√°tusz r√°cs a jobb oldalon */
    .status-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 1rem;
    }
    .status-card {
      padding: 0.75rem 1rem;
      text-align: center;
    }
    .status-card h3 {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
    }
    .status-card p {
      font-size: 1.75rem;
      line-height: 1.1;
      font-weight: 900;
      letter-spacing: -0.02em;
      margin-top: 0.25rem;
    }
    .status-card .health-bar-bg {
      margin-top: 0.35rem;
    }
    .status-card .pond-health-text {
      font-size: 0.75rem;
      font-weight: 600;
      margin-top: 0.25rem;
    }

    /* Admin panelek (√∂sszecsukhat√≥) */
    .admin-details {
      border: 1px solid var(--border);
      border-radius: 1rem;
      background: rgba(255,255,255,0.4);
    }
    .dark .admin-details {
      background: rgba(20,35,60,0.3);
    }
    .admin-details summary {
      font-weight: 600;
      padding: 0.75rem 1rem;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .admin-details summary:hover {
      background: rgba(20,35,60,0.05);
    }
    .dark .admin-details summary:hover {
      background: rgba(225,234,204,0.05);
    }
    .admin-details .admin-details-content {
      padding: 0 1rem 1rem 1rem;
      border-top: 1px solid var(--border);
    }

    /* Elemz≈ë T√©r (√∂sszecsukhat√≥) */
    .analysis-bay summary {
      font-size: 1.25rem;
      font-weight: 700;
      padding: 0.75rem 1.25rem;
      cursor: pointer;
      border-radius: 1.25rem;
      transition: background-color 0.2s ease;
    }
    .analysis-bay summary:hover {
      background: rgba(20,35,60,0.05);
    }
    .dark .analysis-bay summary:hover {
      background: rgba(225,234,204,0.05);
    }
    .analysis-bay[open] summary {
      border-bottom-left-radius: 0;
      border-bottom-right-radius: 0;
    }
    
    /* Diszkr√©t Vagyon Mod√°lis Ablak */
    #player-wealth-modal .modal-content {
      max-width: 320px;
      text-align: center;
      padding: 2rem;
    }
    #player-wealth-modal h2 {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text);
    }
    #player-wealth-modal h3 {
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
      margin-top: 1rem;
    }
    #player-wealth-modal p {
      font-size: 3.5rem;
      font-weight: 900;
      line-height: 1;
      color: var(--c-turq);
      margin-top: 0.5rem;
    }
    #player-wealth-modal button {
      margin-top: 1.5rem;
      width: 100%;
    }
    .player-rep-icon {
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .player-rep-icon:hover {
      transform: scale(1.2);
    }
/* === v8.8 Vesz√©lyz√≥na Kijelz≈ëk === */
    .status-card.card-caution {
      background-color: rgba(228, 193, 87, 0.25) !important; /* --c-gold halv√°ny h√°tt√©rrel */
      border-color: var(--c-gold);
    }
    .status-card.card-danger {
      background-color: rgba(242, 79, 75, 0.2) !important; /* --c-red halv√°ny h√°tt√©rrel */
      border-color: var(--c-red);
      animation: pulse-warning 2s infinite; /* A megl√©v≈ë pulz√°l√≥ anim√°ci√≥ */
    }
    .text-danger {
      color: var(--c-red) !important;
      font-weight: 900;
    }
    
/* === v8.9 Tr√©ning √ñsszes√≠t≈ë === */
    .debrief-table-container {
      max-height: 400px; /* Korl√°tozza a magass√°got, g√∂rgethet≈ëv√© teszi */
      overflow-y: auto;
    }
    .debrief-table {
      font-size: 0.8rem;
    }
    .debrief-table th {
      position: sticky; /* Odafagyasztja a fejl√©cet */
      top: 0;
      background: var(--table-head); /* H√°tt√©r a fejl√©cnek, hogy ne l√°tsz√≥djon √°t */
      padding: 6px 8px;
      border: 1px solid var(--border);
    }
    .debrief-table td {
      padding: 5px 8px;
      border: 1px solid var(--border);
    }
    .debrief-table tfoot {
      position: sticky;
      bottom: 0;
      background: var(--table-head);
    }
    .col-overfish-pos {
      color: #166534; /* s√∂t√©tz√∂ld */
      font-weight: 700;
    }
    .dark .col-overfish-pos {
      color: #6ee7b7; /* vil√°gosz√∂ld */
    }
    .col-overfish-neg {
      color: var(--c-red);
      font-weight: 700;
    }
    .col-wealth {
      font-weight: 700;
    }
</style>
</head>
<body>
<div class="relative z-10 p-4 sm:p-6 lg:p-8 max-w-screen-2xl mx-auto" id="app">
<header class="flex items-center justify-between mb-8">
<div class="flex items-center gap-3">
<div class="h-10 w-10 rounded-xl shadow-lg flex items-center justify-center" style="background: var(--c-turq); box-shadow: 0 10px 18px rgba(84,191,178,.35);">
<svg aria-hidden="true" class="w-6 h-6" style="color:#0b1a2c" viewbox="0 0 24 24"><path d="M5 4h3v16H5zM16 4h3v16h-3zM8 11h8v2H8z" fill="currentColor"></path></svg>
</div>
<h1 class="text-3xl md:text-4xl font-black tracking-tight" style="background: linear-gradient(90deg, var(--c-navy), var(--c-turq)); -webkit-background-clip: text; color: transparent;">Halast√≥ ‚Äì Facilit√°tor Dashboard</h1>
</div>
<div class="flex items-center gap-3">
<button class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border bg-white/80 dark:bg-white/10" id="log-toggle-btn" style="border-color: var(--border); color: var(--text);"><svg class="w-4 h-4 opacity-90" fill="currentColor" viewbox="0 0 24 24"><path d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4z"></path></svg><span class="text-sm font-medium">J√°t√©knapl√≥</span></button>
<button class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border bg-white/80 dark:bg-white/10" id="theme-toggle" style="border-color: var(--border); color: var(--text);"><svg aria-hidden="true" class="w-4 h-4 opacity-90" fill="currentColor" id="theme-icon" viewbox="0 0 24 24"><path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12Z M12 2v2M12 20v2M4 12H2M22 12h-2M5 5l-1.5-1.5M20.5 20.5 19 19M19 5l1.5-1.5M5 19 3.5 20.5"></path></svg><span class="text-sm font-medium">T√©ma</span></button>
</div>
</header>
<div class="max-w-xl mx-auto p-6 md:p-8 rounded-2xl card-glass card-hover shadow-md" id="setup-screen">
<h2 class="text-2xl font-bold text-center mb-6" style="color:var(--text)">J√°t√©k ind√≠t√°sa</h2>
<div class="space-y-4">
<div>
<label class="block text-sm font-medium" for="player-count" style="color:var(--muted)">Hal√°szok sz√°ma (4‚Äì10)</label>
<input class="mt-1 block w-full rounded-xl border shadow-sm p-3 focus:outline-none focus:ring-2" id="player-count" max="10" min="4" name="player-count" style="border-color: var(--border); background: rgba(255,255,255,.9); color:var(--text);" type="number" value="4"/>
</div>
<div class="flex items-center justify-between">
<button class="inline-flex items-center gap-2 font-semibold py-3 px-5 rounded-xl shadow-lg transition-transform active:scale-[.98] btn-primary" id="start-game-btn"><svg aria-hidden="true" class="w-4 h-4" fill="currentColor" viewbox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>√öj j√°t√©k ind√≠t√°sa</button>
<button class="inline-flex items-center gap-2 font-medium py-3 px-4 rounded-xl border transition-colors" id="demo-fill-btn" style="border-color: var(--border); color:var(--text); background: rgba(225,234,204,.45);"><svg aria-hidden="true" class="w-4 h-4" fill="currentColor" viewbox="0 0 24 24"><path d="M3 12h18v2H3zM3 7h12v2H3zM3 17h8v2H3z"></path></svg>Minta adatok</button>
</div>
</div>
</div>
<div class="hidden" id="game-screen">
<section class="mb-8" id="cockpit-grid">
<div class="p-6 rounded-2xl card-glass card-hover shadow-md">
<div class="table-head -mt-6 -mx-6 mb-4 p-3 rounded-t-xl text-center">
<h2 class="text-2xl font-bold" id="main-day-indicator" style="color: var(--text)"></h2>
<h3 class="text-lg font-medium" id="season-indicator" style="color: var(--muted)"></h3>
</div>
<div class="p-3 my-4 text-center rounded-2xl card-glass text-sm italic font-medium" id="daily-analysis-display" style="color: var(--text)"></div>
<button class="w-full font-semibold py-3 px-4 rounded-xl shadow-md transition-transform active:scale-[.98] mb-4" id="end-round-btn" style="background: var(--c-turq); color:#0b1a2c;"><span class="inline-flex items-center gap-2"></span></button>
<div class="space-y-3" id="player-inputs"></div>
</div>
<div class="flex flex-col gap-6">
<div class="status-grid">
<div class="rounded-2xl card-glass card-hover shadow status-card" id="pond-status-card"><h3 title="Halak a t√≥ban">Halak a t√≥ban</h3><p id="pond-status" style="color:var(--text)">100</p></div>
<div class="rounded-2xl card-glass card-hover shadow status-card" id="sustainable-catch-card"><h3 title="Fenntarthat√≥ fog√°s (stabil)">Fennt. Fog√°s</h3><p id="sustainable-catch-display" style="color:var(--c-turq)">0</p></div>
<div class="rounded-2xl card-glass card-hover shadow status-card" id="max-growth-catch-card"><h3 title="Max. N√∂veked√©s Fog√°s">Max. Fog√°s</h3><p id="max-growth-catch-display" style="color:var(--c-turq)">0</p></div>
<div class="rounded-2xl card-glass card-hover shadow editable-stat status-card" id="fixed-cost-card"><h3 title="Fix k√∂lts√©g">Fix K√∂lts√©g</h3><div id="fixed-cost-display-container"><p id="fixed-cost-display" style="color:var(--text)">0</p></div></div>
<div class="rounded-2xl card-glass card-hover shadow status-card"><h3 title="T√≥ Eg√©szs√©ge">T√≥ Eg√©szs√©ge</h3><p id="pond-health-display">100%</p><div class="w-full h-2 rounded-full mt-1 health-bar-bg"><div class="h-full rounded-full" id="pond-health-bar-inner" style="width: 100%;"></div></div><p class="pond-health-text" id="pond-health-text" style="color:var(--muted)"></p></div>
<div class="rounded-2xl card-glass card-hover shadow status-card"><h3 title="Bank (Ad√≥)">Bank (Ad√≥)</h3><p id="bank-status" style="color:var(--c-gold)">0</p></div>
</div>
<details class="admin-details">
<summary>√Åttekint≈ë t√°bl√°zat</summary>
<div class="admin-details-content pt-4 debrief-table-container">
<table class="w-full text-sm debrief-table">
<thead class="table-head">
<tr>
<th>Hal√°sz</th>
<th>St√°tusz</th>
<th>Vagyon</th>
<th>√ñsszes Fog√°s (%)</th>
<th>T√∫lhal√°sz√°s</th>
<th>H√≠rn√©v +/-</th>
<th>√ñsszes K√∂lts√©g</th>
</tr>
</thead>
<tbody id="debrief-table-body">
</tbody>
<tfoot class="table-head font-bold" id="debrief-table-foot">
</tfoot>
</table>
</div>
</details>
<section class="card-glass rounded-2xl" id="active-effects-section">
<h3 class="text-lg font-semibold pt-4 px-4 text-center" style="color:var(--text)">Esem√©nyek</h3>
<div class="space-y-3 p-4" id="active-effects-panel"></div>
</section>
<div class="space-y-4">
<details class="admin-details">
<summary>Esem√©ny ind√≠t√°sa</summary>
<div class="admin-details-content pt-4 space-y-4">
<div>
<h3 class="text-sm font-semibold mb-2" style="color:var(--muted)">Piaci k√∂rnyezet</h3>
<div class="space-y-3">
<select class="block w-full rounded-xl border shadow-sm p-2.5" id="market-card-select" style="border-color: var(--border); background: rgba(255,255,255,.9); color:var(--text);"></select>
<button class="w-full font-semibold py-2.5 px-4 rounded-xl shadow-md" id="trigger-market-btn" style="background: var(--c-cream); color:#283142;">Piac aktiv√°l√°sa</button>
</div>
</div>
<div>
<h3 class="text-sm font-semibold mb-2" style="color:var(--muted)">V√°ratlan esem√©ny</h3>
<div class="space-y-3">
<select class="block w-full rounded-xl border shadow-sm p-2.5" id="chaos-card-select" style="border-color: var(--border); background: rgba(255,255,255,.9); color:var(--text);"></select>
<div class="grid grid-cols-1 gap-2">
<button class="w-full font-semibold py-2.5 px-2 rounded-xl shadow-md btn-secondary" id="trigger-chaos-btn">Be√°ll√≠t√°s</button>
</div>
</div>
</div>
</div>
</details>
<details class="admin-details">
<summary>Adminisztr√°ci√≥ √©s Be√°ll√≠t√°sok</summary>
<div class="admin-details-content pt-4 space-y-4">
<section id="event-advisor-panel"></section>
<div class="grid grid-cols-2 gap-2">
<button class="w-full font-semibold py-2.5 px-4 rounded-xl shadow-md" id="show-audit-log-btn" style="background:var(--c-cream); color:#283142;">Audit Napl√≥</button>
<button class="w-full font-semibold py-2.5 px-4 rounded-xl shadow-md btn-primary" id="export-pdf-btn"><span class="inline-flex items-center justify-center gap-2"><svg aria-hidden="true" class="w-4 h-4" fill="currentColor" viewbox="0 0 24 24"><path d="M12 3v12l4-4h-3V3zM5 19h14v2H5z"></path></svg>PDF</span></button>
<button class="w-full font-semibold py-2.5 px-4 rounded-xl shadow-md text-sm" disabled="" id="undo-btn" style="background:var(--c-cream); color:#283142;">Visszavon</button>
<button class="w-full font-semibold py-2.5 px-4 rounded-xl shadow-md btn-danger" id="new-game-btn"><span class="inline-flex items-center justify-center gap-2"><svg aria-hidden="true" class="w-4 h-4" fill="currentColor" viewbox="0 0 24 24"><path d="M12 5v14m-7-7h14"></path></svg>√öj J√°t√©k</span></button>
</div>
<details>
<summary class="font-semibold cursor-pointer text-sm" style="color: var(--text);">Id≈ëz√≠t≈ë</summary>
<div class="border-t mt-2 pt-4" style="border-color:var(--border)">
<div class="text-4xl font-bold text-center" id="timer-display" style="color:var(--text)">00:00</div>
<div class="grid grid-cols-2 gap-2 mt-2 text-sm">
<select class="w-full p-1 rounded-lg border" id="timer-select" style="border-color:var(--border); background:rgba(255,255,255,.9)"><option value="60">1 perc</option><option value="120">2 perc</option><option selected="" value="180">3 perc</option><option value="240">4 perc</option><option value="300">5 perc</option></select>
<label class="flex items-center gap-1.5"><input class="rounded" id="timer-mute" type="checkbox"/> N√©m√≠t√°s</label>
</div>
<div class="grid grid-cols-2 gap-2 mt-2">
<button class="w-full text-sm font-semibold py-2 px-2 rounded-lg btn-primary" id="timer-start-btn">Start</button>
<button class="w-full text-sm font-semibold py-2 px-2 rounded-lg" id="timer-reset-btn" style="background:var(--c-cream); color:#283142;">Reset</button>
</div>
</div>
</details>


<div class="space-y-4">


</div>
<details>
<summary class="font-semibold cursor-pointer text-sm text-amber-600">Isteni Beavatkoz√°s</summary>
<div class="mt-4 space-y-4 text-sm p-3 rounded-lg border-t pt-4" style="background: rgba(228, 193, 87, 0.1); border-color:var(--border)">
<h4 class="font-medium">C√©lpontok</h4>
<label class="flex items-center gap-1.5 text-xs"><input class="rounded" id="divine-target-all" type="checkbox"/> <strong>Mindenki</strong></label>
<div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs pl-2" id="divine-player-selector">
</div>
<hr style="border-color:var(--border)"/>
<h4 class="font-medium">T√≥ (Glob√°lis)</h4>
<div>
<label>Halak a t√≥hoz (+/-)</label>
<div class="flex gap-2 mt-1">
<input class="w-full p-2 border rounded-lg" id="divine-fish-amount" placeholder="pl. 50 vagy -20" type="number"/>
<button class="px-3 rounded-lg btn-secondary" id="divine-fish-btn">OK</button>
</div>
</div>
<div>
<label>Ideiglenes szaporulat</label>
<div class="grid grid-cols-2 gap-2 mt-1">
<input class="p-2 border rounded-lg" id="divine-regen-modifier" placeholder="Szorz√≥ (pl. 2.5)" step="0.1" type="number"/>
<input class="p-2 border rounded-lg" id="divine-regen-duration" placeholder="Id≈ëtartam (nap)" type="number"/>
</div>
<button class="w-full mt-2 py-1.5 rounded-lg btn-secondary" id="divine-regen-btn">Alkalmaz</button>
</div>
<hr style="border-color:var(--border)"/>
<h4 class="font-medium">J√°t√©kos(ok) (C√©lzott)</h4>
<div>
<label>J√°t√©kos Vagyona (+/-)</label>
<div class="flex gap-2 mt-1">
<input class="w-full p-2 border rounded-lg" id="divine-player-fish-amount" placeholder="pl. 10 vagy -10" type="number"/>
<button class="px-3 rounded-lg btn-secondary" id="divine-player-fish-btn">Alkalmaz (Kijel√∂ltekre)</button>
</div>
</div>
<div>
<label>Ideiglenes ad√≥/t√°mogat√°s</label>
<div class="grid grid-cols-2 gap-2 mt-1">
<input class="p-2 border rounded-lg" id="divine-tax-modifier" placeholder="Ad√≥ (+/-)" type="number"/>
<input class="p-2 border rounded-lg" id="divine-tax-duration" placeholder="Id≈ëtartam (nap)" type="number"/>
</div>
<button class="w-full mt-2 py-1.5 rounded-lg btn-secondary" id="divine-tax-btn">Alkalmaz (Kijel√∂ltekre)</button>
</div>
<div>
<label>Rakt√°rt≈±z (vagyonveszt√©s)</label>
<div class="flex gap-2 mt-1">
<input class="w-full p-2 border rounded-lg" id="divine-fire-percent" placeholder="Sz√°zal√©k (%)" type="number"/>
<button class="px-3 rounded-lg btn-danger" id="divine-fire-btn">Ind√≠t (Kijel√∂ltekre)</button>
</div>
</div>
</div>
</details><details>
<summary class="font-semibold cursor-pointer text-sm" style="color: var(--text);">PDF Riport Tartalma</summary>
<div class="mt-4 space-y-2 text-sm border-t pt-4" id="pdf-section-picker" style="color:var(--text); border-color:var(--border)">
<label class="flex items-center gap-2"><input checked="" class="rounded" name="pdf-sections" type="checkbox" value="#chart1-container"/> <span>T√≥ √°llapota √©s esem√©nyek</span></label>
<label class="flex items-center gap-2"><input checked="" class="rounded" name="pdf-sections" type="checkbox" value="#sustainability-container"/> <span>Fenntarthat√≥ hal√°szat index</span></label>
<label class="flex items-center gap-2"><input checked="" class="rounded" name="pdf-sections" type="checkbox" value="#chart3-container"/> <span>Hal√°szok vagyona k√∂r√∂nk√©nt</span></label>
<label class="flex items-center gap-2"><input checked="" class="rounded" name="pdf-sections" type="checkbox" value="#chart4-container"/> <span>Kihal√°sz√°s k√∂r√∂nk√©nt</span></label>
<label class="flex items-center gap-2"><input class="rounded" name="pdf-sections" type="checkbox" value="#log-panel"/> <span>J√°t√©knapl√≥</span></label>
<label class="flex items-center gap-2"><input class="rounded" name="pdf-sections" type="checkbox" value="#audit-log-modal-content"/> <span>Audit Napl√≥</span></label>
<p class="text-xs mt-2" style="color:var(--muted)">Ha semmit nem jel√∂lsz, az alap n√©gy blokk ker√ºl a PDF-re.</p>
</div>
</details></div>
</details></div></div></section>
<details class="analysis-bay card-glass rounded-2xl shadow-md" id="analysis-bay-details">
<summary class="text-lg font-semibold">üìä Elemz√©s √©s Grafikonok Megjelen√≠t√©se</summary>
<div class="p-6 space-y-8">
<details class="block" id="player-wealth-section" open="">
<summary class="text-lg font-semibold text-center mb-2 cursor-pointer" style="color:var(--text)">
<div class="flex justify-center items-center gap-3 flex-wrap">
<h3>Hal√°szok jelenlegi vagyona</h3>
<span class="text-sm font-semibold px-3 py-1 rounded-full tag-muted">√ñsszesen: <span id="total-wealth-number">0</span> hal</span>
</div>
</summary>
<div class="p-6 rounded-2xl card-glass card-hover shadow mt-2" id="chart2-container">
<div class="relative w-full max-w-[1000px] mx-auto h-[360px]"><canvas id="player-wealth-chart"></canvas></div>
</div>
</details>
<section class="grid grid-cols-1 gap-8">
<div class="p-6 rounded-2xl card-glass card-hover shadow" id="chart1-container"><h3 class="text-lg font-semibold text-center mb-4" style="color:var(--text)">T√≥ √°llapota √©s esem√©nyek</h3><div class="relative w-full max-w-[1000px] mx-auto h-[380px]"><canvas id="pond-history-chart"></canvas></div></div>
<div class="p-6 rounded-2xl card-glass card-hover shadow" id="chart3-container"><h3 class="text-lg font-semibold text-center mb-4" style="color:var(--text)">Hal√°szok vagyona naponk√©nt</h3><div class="relative w-full max-w-[1000px] mx-auto h-[360px]"><canvas id="player-wealth-history-chart"></canvas></div></div>
<div class="p-6 rounded-2xl card-glass card-hover shadow" id="chart4-container"><h3 class="text-lg font-semibold text-center mb-4" style="color:var(--text)">Kihal√°sz√°s naponk√©nt</h3><div class="relative w-full max-w-[1000px] mx-auto h-[360px]"><canvas id="catch-history-chart"></canvas></div></div>
<div class="p-6 rounded-2xl card-glass card-hover shadow" id="sustainability-container"><h3 class="text-lg font-semibold text-center mb-2" style="color:var(--text)">Fenntarthat√≥ hal√°szat index</h3><div class="text-center text-xs mb-4" style="color:var(--muted)">A <strong style="color:#227a66">pozit√≠v k√ºl√∂nbs√©g</strong> fenntarthat√≥ hal√°szatot jelez (a maxim√°lis fenntarthat√≥ fog√°s alatt maradtatok), m√≠g a <strong style="color:var(--c-red)">negat√≠v</strong> a t√∫lzott kihal√°sz√°st.</div><div class="sustainability-table-container"><table class="w-full text-sm text-left" style="color:var(--text)"><thead class="text-xs table-head sticky top-0" style="color:#1f2937"><tr><th class="px-6 py-3">Nap</th><th class="px-6 py-3">Fenntarthat√≥ fog√°s (MFF)</th><th class="px-6 py-3">T√©nyleges fog√°s</th><th class="px-6 py-3">K√ºl√∂nbs√©g</th></tr></thead><tbody id="sustainability-table-body"></tbody></table></div></div>
</section>
</div>
</details>
</div>
</div>
<div aria-labelledby="modal-title" aria-modal="true" class="modal fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none" id="chaos-modal" role="dialog"><div class="rounded-2xl shadow-2xl p-6 sm:p-8 max-w-lg w-full transform transition-transform duration-300 scale-95" style="background: var(--card); border: 1px solid var(--border);"><h2 class="text-2xl font-bold mb-4" id="modal-title" style="color:var(--text)"></h2><div class="modal-body mb-6" id="modal-body" style="color:var(--muted)"></div><div class="flex justify-end gap-3" id="modal-footer"></div></div></div>
<aside class="flex flex-col" id="log-panel"><div class="p-4 flex justify-between items-center border-b" style="border-color: var(--border);"><h2 class="text-xl font-bold" style="color: var(--text);">J√°t√©knapl√≥</h2><button class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" id="log-close-btn"><svg class="w-5 h-5" fill="currentColor" viewbox="0 0 20 20"><path clip-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" fill-rule="evenodd"></path></svg></button></div><div class="flex-grow p-4 overflow-y-auto space-y-3" id="log-content"></div></aside>
<div class="modal fixed inset-0 bg-black/60 flex items-center justify-center p-4 opacity-0 pointer-events-none" id="audit-log-modal">
<div class="rounded-2xl shadow-2xl p-6 sm:p-8 max-w-7xl w-full h-full flex flex-col transform transition-transform duration-300 scale-95" id="audit-log-modal-content" style="background: var(--card); border: 1px solid var(--border);">
<div class="flex justify-between items-center mb-4">
<h2 class="text-2xl font-bold" style="color:var(--text)">Audit Napl√≥</h2>
<div class="flex items-center gap-6">
<div class="flex items-center gap-3 text-sm">
<span class="font-medium">N√©zet:</span>
<label class="flex items-center gap-1.5"><input checked="" class="rounded" name="audit-grouping" type="radio" value="by-day"/> Napok szerint</label>
<label class="flex items-center gap-1.5"><input class="rounded" name="audit-grouping" type="radio" value="by-player"/> Hal√°szok szerint</label>
</div>
<select class="rounded-xl border shadow-sm p-2.5" id="audit-log-player-filter" style="border-color: var(--border); background: rgba(255,255,255,.9); color:var(--text);"></select>
<button class="px-4 py-2 rounded-xl btn-danger" id="audit-log-close-btn">Bez√°r√°s</button>
</div>
</div>
<div class="modal-body flex-grow" id="audit-log-table-container">
<p class="text-center p-8" style="color:var(--muted)">Nincsenek megjelen√≠thet≈ë adatok.</p>
</div>
</div>
</div>
<div aria-labelledby="player-wealth-title" aria-modal="true" class="modal fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none" id="player-wealth-modal" role="dialog">
<div class="modal-content rounded-2xl shadow-2xl transform transition-transform duration-300 scale-95" style="background: var(--card); border: 1px solid var(--border);">
<h2 id="player-wealth-title">J√°t√©kos Vagyona</h2>
<h3>Jelenlegi Vagyonod:</h3>
<p id="player-wealth-amount">0</p>
<button class="px-4 py-2 rounded-xl btn-primary" id="player-wealth-close-btn">Bez√°r√°s</button>
</div>
</div>
<div id="flash-overlay"></div>
<div id="toast-container"></div>
<script>
    const { jsPDF } = window.jspdf;

    (function registerAnnotation(){ try { const plugin = window['chartjs-plugin-annotation']; if (plugin && typeof Chart !== 'undefined') Chart.register(plugin); } catch(e){ console.warn('Annotation plugin nem el√©rhet≈ë.'); } })();

    Chart.defaults.font.family = "'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif";
    Chart.defaults.font.size = 12;
    const isDark = () => document.documentElement.classList.contains('dark');
    function applyChartTheme(){
      const grid = isDark()? 'rgba(255,255,255,0.10)' : 'rgba(20,35,60,0.12)';
      const tick = isDark()? '#E6ECF4' : '#3b4a62';
      Chart.defaults.color = tick; Chart.defaults.borderColor = grid;
      Chart.defaults.plugins.legend.labels.color = isDark()? '#F2F6FD' : '#14233C';
      Chart.defaults.plugins.tooltip.backgroundColor = isDark()? 'rgba(10,16,28,0.95)' : 'rgba(255,255,255,0.98)';
      Chart.defaults.plugins.tooltip.titleColor = isDark()? '#E6ECF4' : '#14233C';
      Chart.defaults.plugins.tooltip.bodyColor  = isDark()? '#E6ECF4' : '#14233C';
      Chart.defaults.datasets.bar.borderRadius = 8;
    }
    applyChartTheme();

    // DOM elemek az √∫j UI-hoz igaz√≠tva
    const dom = {
        setupScreen: document.getElementById('setup-screen'), gameScreen: document.getElementById('game-screen'), playerCountInput: document.getElementById('player-count'),
        startGameBtn: document.getElementById('start-game-btn'), demoFillBtn: document.getElementById('demo-fill-btn'), endGameBtn: document.getElementById('end-round-btn'),
        newGameBtn: document.getElementById('new-game-btn'), exportPdfBtn: document.getElementById('export-pdf-btn'), undoBtn: document.getElementById('undo-btn'),
        playerInputsContainer: document.getElementById('player-inputs'), pondStatusDisplay: document.getElementById('pond-status'), bankStatusDisplay: document.getElementById('bank-status'),
        fixedCostCard: document.getElementById('fixed-cost-card'), fixedCostDisplayContainer: document.getElementById('fixed-cost-display-container'), fixedCostDisplay: document.getElementById('fixed-cost-display'),
        sustainableCatchCard: document.getElementById('sustainable-catch-card'), maxGrowthCatchCard: document.getElementById('max-growth-catch-card'),
        sustainableCatchDisplay: document.getElementById('sustainable-catch-display'), maxGrowthCatchDisplay: document.getElementById('max-growth-catch-display'),
        activeEffectsSection: document.getElementById('active-effects-section'), activeEffectsPanel: document.getElementById('active-effects-panel'),
        chaosCardSelect: document.getElementById('chaos-card-select'), triggerChaosBtn: document.getElementById('trigger-chaos-btn'),
        marketCardSelect: document.getElementById('market-card-select'), triggerMarketBtn: document.getElementById('trigger-market-btn'),
        chaosModal: document.getElementById('chaos-modal'), modalTitle: document.getElementById('modal-title'), modalBody: document.getElementById('modal-body'), modalFooter: document.getElementById('modal-footer'),
        sustainabilityTableBody: document.getElementById('sustainability-table-body'), totalWealthNumber: document.getElementById('total-wealth-number'), flashOverlay: document.getElementById('flash-overlay'),
        pondHealthDisplay: document.getElementById('pond-health-display'), pondHealthBar: document.getElementById('pond-health-bar-inner'),
        pondHealthText: document.getElementById('pond-health-text'),
        eventAdvisorPanel: document.getElementById('event-advisor-panel'),
        showAuditLogBtn: document.getElementById('show-audit-log-btn'),
        auditLogModal: document.getElementById('audit-log-modal'),
        auditLogModalContent: document.getElementById('audit-log-modal-content'),
        auditLogCloseBtn: document.getElementById('audit-log-close-btn'),
        auditLogPlayerFilter: document.getElementById('audit-log-player-filter'),
        auditLogTableContainer: document.getElementById('audit-log-table-container'),
        mainDayIndicator: document.getElementById('main-day-indicator'),
        seasonIndicator: document.getElementById('season-indicator'),
        dailyAnalysisDisplay: document.getElementById('daily-analysis-display'),
        playerWealthModal: document.getElementById('player-wealth-modal'),
        playerWealthTitle: document.getElementById('player-wealth-title'),
        playerWealthAmount: document.getElementById('player-wealth-amount'),
        playerWealthCloseBtn: document.getElementById('player-wealth-close-btn'),
        // v8.9
        debriefTableBody: document.getElementById('debrief-table-body'),
        debriefTableFoot: document.getElementById('debrief-table-foot'),
        // v8.10
        divinePlayerSelector: document.getElementById('divine-player-selector'),
    };

    let gameState = {};
    let playerWealthChart, pondHistoryChart, playerWealthHistoryChart, catchHistoryChart;
    let isExporting = false;
    let undoStack = [];
    const playerColors = ['#54BFB2', '#E4C157', '#F24F4B', '#7BD3C8', '#F0D88A', '#F68C89', '#2B3F5E', '#9AD7CF', '#FFEAB3', '#F9A3A0'];
    const annotationColors = { globalBad: 'rgba(242, 79, 75, 0.15)', globalGood: 'rgba(84, 191, 178, 0.15)', playerBad: 'rgba(228, 193, 87, 0.2)', playerGood: 'rgba(139, 92, 246, 0.15)', playerNeutral: 'rgba(100, 116, 139, 0.15)', globalPending: 'rgba(99, 102, 241, 0.15)' };
    const effectIcons = { global: 'üåç', player: 'üë§', positive: 'üìà', negative: 'üìâ', neutral: '‚öñÔ∏è', pending: 'üïí' };
    
    const GAME_CONFIG = {
        POND_REPRODUCTION_RATE: 2.0,
        DROUGHT_REPRODUCTION_RATE: 1.5,
        STORM_CATCH_MODIFIER: 0.4,
        
        POND_HEALTH: {
            OVERFISHING_PENALTY_DIVISOR: 2,
            MAX_PENALTY_PER_ROUND: 10,
            RECOVERY_PER_ROUND: 2,
            RECOVERY_BONUS_FACTOR: 0.1,
        },

        REPUTATION: {
            OVERFISHING_THRESHOLD: 1.2, // 120%
            UNDERFISHING_THRESHOLD: 0.8, // 80%
            CHANGE_VALUE: 1,
            MAX_VALUE: 5,
            MIN_VALUE: -5
        },
        
        BANKRUPTCY_REHAB_TAX: {
            DURATION: 5,
            AMOUNT: 1
        },
        
        PROGRESSIVE_TAX: {
            WEALTH_TIER_1: 5,
            WEALTH_TIER_2: 10,
            TAX_TIER_1: 0,
            TAX_TIER_2: 1,
            TAX_TIER_3_RATE: 0.1, // 10%
        },
        
        FIXED_COSTS: {
            4: 6, 5: 5, 6: 4, 7: 4, 8: 3, 9: 3, 10: 3
        },
        
        CATCH_VALUE: {
            DEFAULT: 1,
            INFECTION: 0.5,
            BOOM: 2,
            DUMPING: 0.5,
            TRAINING_BONUS: 3, // TR√âNING K√ÅRTYA M√ìDOS√çTVA
        },

        POLLUTED_WATER: {
            ARM_THRESHOLD: 2,
            START_DELAY: 2,
            MIN_MULTIPLIER: 0.5,
            RECOVERY_STEP: 0.1
        },

        SEASONS: {
            cycleLength: 4, // days per season
            seasons: [
                { name: 'Tavasz', icon: 'üå±', regenModifier: 2.2, costModifier: 0, description: 'B≈ë szaporulat, norm√°l k√∂lts√©gek.' },
                { name: 'Ny√°r', icon: '‚òÄÔ∏è', regenModifier: 2.0, costModifier: 0, description: 'Norm√°l szaporulat √©s k√∂lts√©gek.' },
                { name: '≈êsz', icon: 'üçÇ', regenModifier: 1.8, costModifier: 0, description: 'Lassul√≥ szaporulat, norm√°l k√∂lts√©gek.' },
                { name: 'T√©l', icon: '‚ùÑÔ∏è', regenModifier: 1.5, costModifier: 1, description: 'Gyenge szaporulat, extra k√∂lts√©gek.' }
            ]
        }
    };

    function getDayOfWeek(round) { if (round === 0) return 'Kezdeti √°llapot'; const days = ['H√©tf≈ë', 'Kedd', 'Szerda', 'Cs√ºt√∂rt√∂k', 'P√©ntek', 'Szombat', 'Vas√°rnap']; return days[(round - 1) % 7]; }
    function getCurrentSeason(round) { const S = GAME_CONFIG.SEASONS; const seasonIndex = Math.floor(((round - 1) % (S.cycleLength * S.seasons.length)) / S.cycleLength); return S.seasons[seasonIndex]; }
    function getFullDay(round) { return `${round}. nap (${getDayOfWeek(round)})`; }
    function triggerFlash() { dom.flashOverlay.classList.add('active'); setTimeout(() => dom.flashOverlay.classList.remove('active'), 150); }
    function animateNumber(el, to, ms=420, suffix=''){ const from = parseInt((el.textContent||'').replace(/\D/g,'')) || 0; if (from === to) { el.textContent = to.toLocaleString('hu-HU') + suffix; return; } const start = performance.now(); const fmt = n => Math.round(n).toLocaleString('hu-HU') + suffix; function tick(t){ const p = Math.min(1, (t-start)/ms); const eased = p<.5 ? 2*p*p : -1+(4-2*p)*p; el.textContent = fmt(from + (to-from)*eased); if(p<1) requestAnimationFrame(tick); } requestAnimationFrame(tick); }
    function showModal(modalId = 'chaos-modal') { const modal = document.getElementById(modalId); if(modal) { modal.classList.remove('opacity-0','pointer-events-none'); modal.querySelector('div>div').classList.remove('scale-95'); } }
    function hideModal(modalId = 'chaos-modal') { const modal = document.getElementById(modalId); if(modal) { modal.classList.add('opacity-0','pointer-events-none'); modal.querySelector('div>div').classList.add('scale-95'); } }
    function createModalElements(title, bodyHTML, footerButtons, type = 'neutral'){
        const modalContent = dom.chaosModal.querySelector('div>div');
        modalContent.classList.remove('modal-type-good', 'modal-type-bad', 'modal-type-neutral');
        if (type === 'good') modalContent.classList.add('modal-type-good');
        else if (type === 'bad') modalContent.classList.add('modal-type-bad');
        else modalContent.classList.add('modal-type-neutral');
        dom.modalTitle.textContent = title; dom.modalBody.innerHTML = bodyHTML; dom.modalFooter.innerHTML = ''; footerButtons.forEach(btn => { const b = document.createElement('button'); b.textContent = btn.text; b.className = btn.classes; b.onclick = btn.handler; if(btn.id) b.id = btn.id; dom.modalFooter.appendChild(b); }); showModal('chaos-modal');
    }
    const modalCancelButton = { text:'M√©gse', classes:'px-4 py-2 rounded-xl', handler: ()=>hideModal('chaos-modal') };
    const modalOKButton = { text:'√ârtettem', classes:'px-4 py-2 rounded-xl btn-primary', handler: ()=>hideModal('chaos-modal') };
    function getPlayerCheckboxes(filterFn=()=>true, type='checkbox'){ return gameState.players.filter(filterFn).map(p=>`<label class="flex items-center gap-2"><input type="${type}" class="rounded" name="selected_players" value="${p.id}"><span>${p.name}</span></label>`).join(''); }
    function createLotteryButton(playerCheckboxesQuery, count) { const btn = document.createElement('button'); btn.textContent = `Sorsol√°s (${count})`; btn.className = 'px-3 py-1.5 rounded-lg text-sm btn-secondary'; btn.onclick = (e) => { e.preventDefault(); const cbs = Array.from(document.querySelectorAll(playerCheckboxesQuery)); cbs.forEach(cb => cb.checked = false); cbs.sort(() => 0.5 - Math.random()).slice(0, count).forEach(cb => cb.checked = true); }; return btn; }
    function createDurationSelectorHTML(id = "duration_selector") { return `<label class="block text-sm font-medium" style="color:var(--muted)">Id≈ëtartam</label><select id="${id}" class="mt-1 block w-full rounded-xl border shadow-sm p-2.5" style="border-color: var(--border); background: rgba(255,255,255,.9); color:var(--text);"><option value="1">1 nap</option><option value="2">2 nap</option><option value="3">3 nap</option><option value="4">4 nap</option><option value="5">5 nap</option><option value="random">V√©letlen (1-5 nap)</option></select>`; }
    function getDurationFromSelector(id = "duration_selector") { const v = document.getElementById(id).value; if (v === 'random') return Math.floor(Math.random() * 5) + 1; return parseInt(v) || 1; }
    function createStartDelaySelectorHTML(id = "start_delay_selector") { return `<label class="block text-sm font-medium" style="color:var(--muted)">K√©sleltet√©s</label><select id="${id}" class="mt-1 block w-full rounded-xl border shadow-sm p-2.5" style="border-color: var(--border); background: rgba(255,255,255,.9); color:var(--text);"><option value="0">Azonnal</option><option value="1">1 nap m√∫lva</option><option value="2">2 nap m√∫lva</option><option value="3">3 nap m√∫lva</option></select>`; }
    function getStartDelayFromSelector(id = "start_delay_selector") { return parseInt(document.getElementById(id)?.value) || 0; }
    function addAnnotation(label, duration, color, playerId = null, startOffset = 0) { const startRound = gameState.round + startOffset; gameState.annotations.push({ startRound, endRound: startRound + duration - 1, label, color, playerId }); }
    function showToast(message) { const container = document.getElementById('toast-container'); const toast = document.createElement('div'); toast.className = 'toast'; toast.textContent = message; container.appendChild(toast); setTimeout(() => toast.classList.add('show'), 10); setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 400); }, 4000); }
    
    function triggerEffect(effect) { 
        const newEffect = { ...effect, roundTriggered: gameState.round, startOffset: effect.startOffset || 0 };
        gameState.effectHistory.push(newEffect);
        const annoLabel = newEffect.annoLabel || newEffect.name;
        const annoDuration = newEffect.type === 'instant' ? 1 : newEffect.duration;
        addAnnotation(annoLabel, annoDuration, newEffect.color, newEffect.targets[0], newEffect.startOffset);
        logEvent(`Esem√©ny: ${newEffect.name} aktiv√°lva.`);
        if (newEffect.startOffset > 0) { showToast(`"${newEffect.name}" esem√©ny be√ºtemezve ${newEffect.startOffset} nap m√∫lva.`); }
        renderActiveEffectsPanel();
    }
    
    function addPlayerAdjustment(playerId, amount, details) {
        const player = gameState.players.find(p => p.id === playerId);
        if (!player) return;
        player.fish += amount;
        if (!player.adjustments) player.adjustments = [];
        player.adjustments.push({ amount, details });
    }

    const chaosCards = [
        { id:'none', title:'V√°lassz egy esem√©nyt...' },
        { 
            id:'szennyezett_viz', title:'Szennyezett V√≠z', isInstant: true,
            setupModal: function() {
                const body = `<p>Aktiv√°lja a Szennyezett V√≠z mechanik√°t. Ha a j√°t√©kosok N napon √°t t√∫lhal√°sznak, a t√≥ regener√°ci√≥ja drasztikusan lecs√∂kken.</p>
                <p class="text-xs mt-2" style="color:var(--muted)">Ez egy halad√≥ mechanika, amely tart√≥s negat√≠v spir√°lt okozhat.</p>`;
                const buttons=[modalCancelButton,{text:'Aktiv√°l√°s',classes:'px-4 py-2 rounded-xl btn-danger',handler:()=>this.apply()}]; 
                createModalElements(this.title, body, buttons, 'bad');
            },
            apply: function() {
                const pw = gameState.pollutedWater;
                pw.enabled = true; pw.consecOver = 0; pw.armedAtRound = null; pw.activeFromRound = null; pw.multiplier = 1.0;
                triggerEffect({
                    id: 'szennyezett_viz_armed', name: 'Szennyezett V√≠z', type: 'duration', duration: 99, 
                    description: 'A rendszer √©les√≠tve. A tart√≥s t√∫lhal√°szat cs√∂kkenti a t√≥ regener√°ci√≥j√°t.',
                    targets: ['global'], color: annotationColors.globalBad, icon: 'üíß'
                });
                logEvent('A "Szennyezett V√≠z" mechanika aktiv√°lva.');
                hideModal('chaos-modal'); updateAllUI();
            }
        },
        { 
            id:'silent_rounds', title:'A N√©ma Pr√≥bat√©tel',
            setupModal: function(){ const body = `<p>H√°ny napon √°t tartson a ‚ÄûN√©ma pr√≥bat√©tel‚Äù (kommunik√°ci√≥ tiltva)?</p><div class="grid grid-cols-2 gap-4 mt-4">${createDurationSelectorHTML()}${createStartDelaySelectorHTML()}</div>`; const buttons=[modalCancelButton,{text:'Ind√≠t√°s',classes:'px-4 py-2 rounded-xl btn-primary',handler:() => this.apply()}]; createModalElements(this.title, body, buttons, 'bad'); },
            apply: function(params = {}){ const d = params.duration || getDurationFromSelector(); const o = params.offset !== undefined ? params.offset : getStartDelayFromSelector(); triggerEffect({ id: this.id, name: this.title, type: 'duration', duration: d, startOffset: o, description: 'Kommunik√°ci√≥ tiltva.', targets: ['global'], color: annotationColors.globalBad, icon: effectIcons.global }); hideModal('chaos-modal'); }
        },
        { 
            id:'kiralyi_ado', title:'A Kir√°lyi Ad√≥',
            setupModal: function(){ const body = `<p>Kik fizessenek dupla ad√≥t?</p><div class="space-y-2 my-4">${getPlayerCheckboxes(p=>!p.isBankrupt)}</div><div class="grid grid-cols-2 gap-4">${createDurationSelectorHTML()}${createStartDelaySelectorHTML()}</div>`; const buttons=[modalCancelButton,{text:'Alkalmaz',classes:'px-4 py-2 rounded-xl btn-secondary',handler:()=>this.apply()}]; createModalElements(this.title, body, buttons, 'bad'); dom.modalFooter.prepend(createLotteryButton('input[name="selected_players"]', 2)); },
            apply: function(params = {}){ const d = params.duration || getDurationFromSelector(); const o = params.offset !== undefined ? params.offset : getStartDelayFromSelector(); const players = params.players || Array.from(document.querySelectorAll('input[name="selected_players"]:checked')).map(cb => gameState.players.find(p=>p.id==cb.value)); players.forEach(pl => { if(pl) triggerEffect({ id: this.id, name: this.title, type: 'duration', duration: d, startOffset: o, description: 'Fix k√∂lts√©g: 2x', annoLabel: `Dupla ad√≥ (${pl.name})`, targets: [pl.id], color: annotationColors.playerBad, icon: effectIcons.player }); }); hideModal('chaos-modal'); }
        },
        {
            id:'idegen_halasz', title:'Az Idegen Hal√°sz', isInstant: true,
            setupModal: function() { createModalElements(this.title, `<p>Egy √∫j hal√°sz √©rkezik a k√∂z√∂ss√©gbe.</p>`, [modalCancelButton,{text:'Hozz√°ad√°s',classes:'px-4 py-2 rounded-xl btn-primary',handler:()=>this.apply()}]); },
            apply: function() { const id=gameState.players.length+1; const newName = `Hal√°sz #${id}`; const wh=Array(gameState.round).fill(0), ch=Array(gameState.round).fill(0); gameState.players.push({id, name: newName, fish:0, reputation: 0, isBankrupt:false, adjustments: [], history:{wealth:wh, catch:ch}}); gameState.fixedCost=getFixedCost(gameState.players.length); triggerEffect({ id: this.id, name: this.title, type: 'instant', outcome: `${newName} csatlakozott.`, targets: [], color: annotationColors.playerNeutral, icon: effectIcons.player }); updateAllUI(); setupPlayerInputs(); hideModal('chaos-modal'); }
        },
        { 
            id:'csaladi_ugyek', title:'Csal√°di √ºgyek',
            setupModal: function() {
                const body = `
                    <p>V√°laszd ki az √©rintett j√°t√©kosokat, az id≈ëtartamot, √©s az √∂sszeget (negat√≠v sz√°m a t√°mogat√°s).</p>
                    <div class="space-y-2 my-4">${getPlayerCheckboxes(p=>!p.isBankrupt)}</div>
                    <div class="grid grid-cols-2 gap-4">
                        ${createDurationSelectorHTML()}
                        ${createStartDelaySelectorHTML()}
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium" style="color:var(--muted)">K√∂lts√©g / T√°mogat√°s √∂sszege (pl. 2 vagy -3)</label>
                        <input type="number" id="family_affair_amount" class="mt-1 block w-full rounded-xl border shadow-sm p-2.5" style="border-color: var(--border); background: rgba(255,255,255,.9); color:var(--text);" placeholder="0">
                    </div>`;
                const buttons = [modalCancelButton, { text: 'Alkalmaz', classes: 'px-4 py-2 rounded-xl btn-primary', handler: () => this.apply() }];
                createModalElements(this.title, body, buttons, 'neutral');
            },
            apply: function() {
                const d = getDurationFromSelector();
                const o = getStartDelayFromSelector();
                const amount = parseInt(document.getElementById('family_affair_amount').value) || 0;
                if (amount === 0) {
                    alert("Az √∂sszeg nem lehet nulla.");
                    return;
                }
                const players = Array.from(document.querySelectorAll('input[name="selected_players"]:checked')).map(cb => gameState.players.find(p=>p.id==cb.value));
                players.forEach(pl => {
                    if(pl) {
                        const desc = `Extra k√∂lts√©g: ${amount > 0 ? '+' : ''}${amount}`;
                        triggerEffect({ 
                            id: 'csaladi_ugyek_effect', 
                            name: `Csal√°di √ºgyek (${pl.name})`, 
                            type: 'duration', 
                            duration: d, 
                            startOffset: o, 
                            description: desc, 
                            annoLabel: `Csal√°di √ºgy (${pl.name})`, 
                            targets: [pl.id], 
                            color: amount > 0 ? annotationColors.playerBad : annotationColors.playerGood, 
                            icon: effectIcons.player,
                            modifier: amount
                        });
                    }
                });
                hideModal('chaos-modal');
            }
        },
        {
            id:'portyazok', title:'A Porty√°z√≥k', isInstant: true,
            setupModal: function() { const body=`<p>Kiknek a vagyon√°t d√©zsm√°lj√°k meg a porty√°z√≥k (30% vesztes√©g)?</p><div class="space-y-2">${getPlayerCheckboxes(p=>!p.isBankrupt && p.fish > 0)}</div>`; const buttons=[modalCancelButton,{text:'Alkalmaz',classes:'px-4 py-2 rounded-xl btn-danger',handler:()=>this.apply()}]; createModalElements(this.title, body, buttons, 'bad'); dom.modalFooter.prepend(createLotteryButton('input[name="selected_players"]', 1)); },
            apply: function(params = {}){ const players = params.players || Array.from(document.querySelectorAll('input[name="selected_players"]:checked')).map(cb => gameState.players.find(p=>p.id==cb.value)); players.forEach(pl => { if(pl){ const loss = Math.ceil(pl.fish * 0.3); addPlayerAdjustment(pl.id, -loss, 'Porty√°z√≥k'); triggerEffect({ id: this.id, name: this.title, type: 'instant', outcome: `-${loss} hal`, annoLabel: `Porty√°z√≥k (${pl.name})`, targets: [pl.id], color: annotationColors.playerBad, icon: effectIcons.player }); } }); updateCharts(gameState); hideModal('chaos-modal'); }
        },
        {
            id:'ivohely_projekt', title:'Az √çv√≥hely Projekt', isInstant: true,
            setupModal: function() { const totalWealth = Math.floor(gameState.players.filter(p=>!p.isBankrupt).reduce((sum,p)=>sum+p.fish,0)); const cost = Math.max(100, Math.floor(totalWealth * 0.4)); const body=`<p>Gy≈±jts √∂ssze <strong>${cost}</strong> halat: a t√≥ kapacit√°sa 120-ra n≈ë.</p>` + gameState.players.filter(p=>!p.isBankrupt).map(p=>`<div class="flex items-center justify-between mb-2"><label>${p.name} (${Math.floor(p.fish)})</label><input type="number" data-player-id="${p.id}" value="0" min="0" max="${Math.floor(p.fish)}" class="w-24 p-2 border rounded-xl contribution-input"></div>`).join('') + `<p class="text-right font-bold mt-4">√ñsszesen: <span id="total-contribution">0</span> / ${cost}</p><input type="hidden" id="project-cost" value="${cost}">`; const buttons=[modalCancelButton,{text:'Befektet√©s',classes:'px-4 py-2 rounded-xl btn-primary',handler:()=>this.apply()}]; createModalElements(this.title, body, buttons, 'good'); dom.modalBody.addEventListener('input',e=>{ if(e.target.classList.contains('contribution-input')){ let t=0; document.querySelectorAll('.contribution-input').forEach(i=>t+=(parseInt(i.value)||0)); document.getElementById('total-contribution').textContent=t; }}); },
            apply: function() { let total=0; const cost=parseInt(document.getElementById('project-cost').value); const contribs=[]; document.querySelectorAll('.contribution-input').forEach(i=>{ const a=parseInt(i.value)||0; total+=a; contribs.push({id:parseInt(i.dataset.playerId), amount:a});}); if(total<cost){ alert(`Nincs meg a ${cost} hal!`); return; } const details = []; contribs.forEach(c=>{ const p=gameState.players.find(x=>x.id==c.id); if(p){ if(c.amount > 0) { addPlayerAdjustment(p.id, -c.amount, '√çv√≥hely Projekt'); details.push(`${p.name}: ${c.amount} hal`); } } }); gameState.maxPond=120; triggerEffect({ id: this.id, name: this.title, type: 'duration', duration: 99, description: 'T√≥ kapacit√°sa: 120', annoLabel: 'T√≥ fejlesztve', targets: ['global'], color: annotationColors.globalGood, icon: effectIcons.positive, outcome: `Sikeres (+${total} hal)`, details }); details.forEach(d => logEvent(d, { isDetail: true })); hideModal('chaos-modal'); }
        },
        {
            id:'kozossegi_hozzajarulas', title:'A K√∂z√∂ss√©gi Hozz√°j√°rul√°s',
            setupModal: function() { const body = `<p>Progressz√≠v ad√≥: <5 vagyon=0, 5‚Äì10 vagyon=1, >10 vagyon=10%.</p><div class="grid grid-cols-2 gap-4 mt-4">${createDurationSelectorHTML()}${createStartDelaySelectorHTML()}</div>`; const buttons = [modalCancelButton, {text:'Alkalmaz', classes:'px-4 py-2 rounded-xl btn-secondary', handler: ()=>this.apply()}]; createModalElements(this.title, body, buttons); },
            apply: function(params = {}){ const d = params.duration || getDurationFromSelector(); const o = params.offset !== undefined ? params.offset : getStartDelayFromSelector(); triggerEffect({ id: this.id, name: 'Progressz√≠v Ad√≥', type: 'duration', duration: d, startOffset: o, description: '<5=0, 5-10=1, >10=10%', annoLabel: 'Prog. Ad√≥', targets: ['global'], color: annotationColors.globalBad, icon: effectIcons.neutral }); hideModal('chaos-modal'); }
        },
        {
            id:'beteg_halasz', title:'A Beteg Hal√°sz',
            setupModal: function() { const body = `<p>V√°laszd ki a beteg hal√°szt.</p><div class="space-y-2 my-3">${getPlayerCheckboxes(p=>!p.isBankrupt && !hasEffect(p.id, 'beteg_halasz'), 'radio')}</div><div class="grid grid-cols-2 gap-4">${createDurationSelectorHTML()}${createStartDelaySelectorHTML()}</div>`; const buttons = [modalCancelButton, {text:'Alkalmaz', classes:'px-4 py-2 rounded-xl btn-secondary',handler:()=>this.apply()}]; createModalElements(this.title, body, buttons, 'bad'); },
            apply: function(params = {}){ const d = params.duration || getDurationFromSelector(); const o = params.offset !== undefined ? params.offset : getStartDelayFromSelector(); const selected = params.players ? params.players[0] : gameState.players.find(x=>x.id==document.querySelector('input[name="selected_players"]:checked')?.value); if(selected){ triggerEffect({ id: this.id, name: 'Betegs√©g', type: 'duration', duration: d, startOffset: o, description: 'Nem hal√°szhat.', annoLabel: `Beteg (${selected.name})`, targets: [selected.id], color: annotationColors.playerBad, icon: effectIcons.player }); } hideModal('chaos-modal'); setupPlayerInputs(); }
        },
        {
            id:'kiralyi_sarc', title:'Kir√°lyi Sarc', isInstant: true,
            setupModal: function() { const totalWealth = Math.floor(gameState.players.filter(p=>!p.isBankrupt).reduce((sum,p)=>sum+p.fish,0)); const target = Math.ceil(totalWealth * 0.3); const body=`<p>A kir√°ly <strong>${target}</strong> halat k√∂vetel. Ha nem fizetitek ki, vagy ha a facilit√°tor √∫gy d√∂nt, mindenki vagyon√°nak 30%-√°t elveszi!</p>` + gameState.players.filter(p=>!p.isBankrupt).map(p=>`<div class="flex items-center justify-between mb-2"><label>${p.name} (${Math.floor(p.fish)})</label><input type="number" data-player-id="${p.id}" value="0" min="0" max="${Math.floor(p.fish)}" class="w-24 p-2 border rounded-xl contribution-input"></div>`).join('') + `<p class="text-right font-bold mt-4">√ñsszesen: <span id="total-contribution">0</span> / ${target}</p><input type="hidden" id="tribute-target" value="${target}">`; const buttons=[modalCancelButton,{text:'Sarc Behajt√°sa (B√ºntet√©s)', classes:'px-4 py-2 rounded-xl btn-danger', handler:()=>this.forceCollection(true)},{text:'√ñnk√©ntes Befizet√©s', classes:'px-4 py-2 rounded-xl btn-primary',handler:()=>this.handlePayment()}]; createModalElements(this.title, body, buttons, 'bad'); dom.modalBody.addEventListener('input',e=>{ if(e.target.classList.contains('contribution-input')){ let t=0; document.querySelectorAll('.contribution-input').forEach(i=>t+=(parseInt(i.value)||0)); document.getElementById('total-contribution').textContent=t; }}); },
            handlePayment: function() { let total=0; const target=parseInt(document.getElementById('tribute-target').value); const contribs=[]; document.querySelectorAll('.contribution-input').forEach(i=>{const a=parseInt(i.value)||0; total+=a; contribs.push({id:parseInt(i.dataset.playerId), amount:a});}); const details = []; if(total>=target){ contribs.forEach(c=>{const p=gameState.players.find(x=>x.id==c.id); if(p){ if(c.amount > 0) { addPlayerAdjustment(p.id, -c.amount, 'Kir√°lyi Sarc (√∂nk√©ntes)'); details.push(`${p.name}: ${c.amount} hal`); } } }); gameState.bank += total; triggerEffect({ id: this.id, name: this.title, type: 'instant', outcome: `+${total} hal a banknak`, annoLabel: `Sarc (+${total})`, targets: ['global'], color: annotationColors.globalGood, icon: effectIcons.negative, details }); details.forEach(d => logEvent(d, { isDetail: true })); } else { this.forceCollection(false); } updateCharts(gameState); hideModal('chaos-modal'); },
            forceCollection: function(confirmFirst = true) { if (confirmFirst && !confirm('Biztosan behajtja a sarcot? Ezzel minden j√°t√©kos vagyon√°nak 30%-a levon√°sra ker√ºl.')) return; const details = []; let totalLoss = 0; gameState.players.forEach(p=>{ if(!p.isBankrupt){ const loss = Math.ceil(p.fish * 0.3); if (loss > 0) { addPlayerAdjustment(p.id, -loss, 'Kir√°lyi Sarc (behajt√°s)'); details.push(`${p.name}: -${loss} hal`); totalLoss += loss; } } }); gameState.bank += totalLoss; triggerEffect({ id: this.id, name: this.title, type: 'instant', outcome: `Vagyonveszt√©s (30%), +${totalLoss} a banknak`, annoLabel: `Sarc (sikertelen)`, targets: ['global'], color: annotationColors.globalBad, icon: effectIcons.negative, details }); details.forEach(d => logEvent(d, { isDetail: true })); updateCharts(gameState); hideModal('chaos-modal'); }
        },
        {
            id:'jotekonysag', title:'J√≥t√©konys√°g', isInstant: true,
            setupModal: function() { const body=`<p>√ñnk√©ntes adakoz√°s a Bank r√©sz√©re.</p>` + gameState.players.filter(p=>!p.isBankrupt).map(p=>`<div class="flex items-center justify-between mb-2"><label>${p.name} (${Math.floor(p.fish)})</label><input type="number" data-player-id="${p.id}" value="0" min="0" max="${Math.floor(p.fish)}" class="w-24 p-2 border rounded-xl contribution-input"></div>`).join(''); const buttons=[modalCancelButton,{text:'Felaj√°nl√°s',classes:'px-4 py-2 rounded-xl btn-primary',handler:()=>this.apply()}]; createModalElements(this.title, body, buttons, 'good'); },
            apply: function() { let totalDonation = 0; const details = []; document.querySelectorAll('.contribution-input').forEach(i=>{ const amount=parseInt(i.value)||0; if(amount > 0){ const p = gameState.players.find(x=>x.id==i.dataset.playerId); if(p){ addPlayerAdjustment(p.id, -amount, 'J√≥t√©konys√°g'); totalDonation += amount; details.push(`${p.name}: ${amount} hal`); } } }); gameState.bank += totalDonation; triggerEffect({ id: this.id, name: this.title, type: 'instant', outcome: `+${totalDonation} hal a banknak`, annoLabel: `Adom√°ny (+${totalDonation})`, targets: ['global'], color: annotationColors.globalGood, icon: effectIcons.positive, details }); details.forEach(d => logEvent(d, { isDetail: true })); updateCharts(gameState); hideModal('chaos-modal'); }
        },
        {
            id:'kiralyi_kedvezmeny', title:'Kir√°lyi Kedvezm√©ny',
            setupModal: function() { const body = `<p>Kik mentes√ºlnek a fix k√∂lts√©g al√≥l?</p><div class="space-y-2 my-4">${getPlayerCheckboxes(p=>!p.isBankrupt)}</div><div class="grid grid-cols-2 gap-4">${createDurationSelectorHTML()}${createStartDelaySelectorHTML()}</div>`; const buttons=[modalCancelButton,{text:'Alkalmaz',classes:'px-4 py-2 rounded-xl btn-primary',handler:()=>this.apply()}]; createModalElements(this.title, body, buttons, 'good'); dom.modalFooter.prepend(createLotteryButton('input[name="selected_players"]', 1)); },
            apply: function(params = {}) { const d = params.duration || getDurationFromSelector(); const o = params.offset !== undefined ? params.offset : getStartDelayFromSelector(); const players = params.players || Array.from(document.querySelectorAll('input[name="selected_players"]:checked')).map(cb => gameState.players.find(p=>p.id==cb.value)); players.forEach(pl => { if(pl) triggerEffect({ id: this.id, name: this.title, type: 'duration', duration: d, startOffset: o, description: 'Nincs fix k√∂lts√©g.', annoLabel: `K√∂lts√©gmentes (${pl.name})`, targets: [pl.id], color: annotationColors.playerGood, icon: effectIcons.positive }); }); hideModal('chaos-modal'); }
        },
        {
            id:'vandorkereskedo', title:'V√°ndorkeresked≈ë', isInstant: true,
            setupModal: function() { const body = `<p>A v√°ndorkeresked≈ë meg√©rkezett. Milyen √ºzletet k√∂ssetek?</p>`; const buttons=[modalCancelButton, {text:'K√∂z√∂s alku',classes:'px-4 py-2 rounded-xl btn-primary',handler:()=>this.setupModeA()}, {text:'Tr√©neri jutalom',classes:'px-4 py-2 rounded-xl btn-secondary',handler:()=>this.setupModeB()}]; createModalElements(this.title, body, buttons, 'good'); },
            setupModeA: function() { const activePlayers = gameState.players.filter(p=>!p.isBankrupt).length; const totalWealth = Math.floor(gameState.players.filter(p=>!p.isBankkrupt).reduce((sum,p)=>sum+p.fish,0)); const limit = (activePlayers * 3) + Math.floor(totalWealth * 0.1); const body=`<p>A keresked≈ë <strong>${limit}</strong> halat v√°s√°rol fel +50% b√≥nusz√©rt. Ossz√°tok el a keretet!</p>` + gameState.players.filter(p=>!p.isBankrupt).map(p=>`<div class="flex items-center justify-between mb-2"><label>${p.name} (${Math.floor(p.fish)})</label><input type="number" data-player-id="${p.id}" value="0" min="0" max="${Math.floor(p.fish)}" class="w-24 p-2 border rounded-xl contribution-input"></div>`).join('') + `<p class="text-right font-bold mt-4">Eladott hal: <span id="total-contribution">0</span> / ${limit}</p><input type="hidden" id="merchant-limit" value="${limit}">`; const buttons=[modalCancelButton,{text:'Elad√°s',classes:'px-4 py-2 rounded-xl btn-primary',handler:()=>this.apply()}]; createModalElements('V√°ndorkeresked≈ë ‚Äì K√∂z√∂s Alku', body, buttons, 'good'); dom.modalBody.addEventListener('input',e=>{ if(e.target.classList.contains('contribution-input')){ let t=0; document.querySelectorAll('.contribution-input').forEach(i=>t+=(parseInt(i.value)||0)); document.getElementById('total-contribution').textContent=t; }}); },
            setupModeB: function() { const body=`<p>Add meg, melyik j√°t√©kos mennyi halat adhat el +50% b√≥nusz√©rt.</p>` + gameState.players.filter(p=>!p.isBankrupt).map(p=>`<div class="flex items-center justify-between mb-2"><label>${p.name} (${Math.floor(p.fish)})</label><input type="number" data-player-id="${p.id}" value="0" min="0" max="${Math.floor(p.fish)}" class="w-24 p-2 border rounded-xl contribution-input"></div>`).join(''); const buttons=[modalCancelButton,{text:'Elad√°s',classes:'px-4 py-2 rounded-xl btn-primary',handler:()=>this.apply()}]; createModalElements('V√°ndorkeresked≈ë ‚Äì Tr√©neri Jutalom', body, buttons, 'good'); },
            apply: function() { const limit = document.getElementById('merchant-limit') ? parseInt(document.getElementById('merchant-limit').value) : Infinity; let totalSold = 0; const deals = []; document.querySelectorAll('.contribution-input').forEach(i=>{ const amount=parseInt(i.value)||0; if(amount>0){ totalSold+=amount; deals.push({id:parseInt(i.dataset.playerId), amount}); } }); if(totalSold > limit){ alert(`T√∫ll√©pt√©tek a ${limit} halas keretet!`); return; } const details = []; let totalBonus = 0; deals.forEach(d=>{ const p = gameState.players.find(x=>x.id==d.id); if(p){ const bonus = Math.floor(d.amount * (GAME_CONFIG.CATCH_VALUE.TRAINING_BONUS - 1)); addPlayerAdjustment(p.id, bonus, 'V√°ndorkeresked≈ë B√≥nusz'); totalBonus += bonus; details.push(`${p.name}: ${d.amount} hal (B√≥nusz: +${bonus})`); } }); triggerEffect({ id: this.id, name: this.title, type: 'instant', outcome: `+${totalBonus} hal (√∂ssz. b√≥nusz)`, annoLabel: `Keresked≈ë`, targets: ['global'], color: annotationColors.globalGood, icon: effectIcons.positive, details }); details.forEach(d => logEvent(d, { isDetail: true })); updateCharts(gameState); hideModal('chaos-modal'); }
        },
        {
            id:'trening', title:'Tr√©ningre mentem',
            setupModal: function() {
                const body = `
                    <p>A r√©sztvev≈ëk X napig nem hal√°szhatnak (de k√∂lts√©g√ºk van), majd X napig <strong>3x b√≥nuszt</strong> kapnak a fog√°sukra.</p>
                    <div class="space-y-2 my-4">${getPlayerCheckboxes(p=>!p.isBankrupt)}</div>
                    <div class="grid grid-cols-2 gap-4">${createDurationSelectorHTML()}${createStartDelaySelectorHTML()}</div>`;
                const buttons=[modalCancelButton,{text:'Tr√©ning ind√≠t√°sa',classes:'px-4 py-2 rounded-xl btn-primary',handler:()=>this.apply()}];
                createModalElements(this.title, body, buttons);
            },
            apply: function(params = {}) {
                const d = params.duration || getDurationFromSelector();
                const o = params.offset !== undefined ? params.offset : getStartDelayFromSelector();
                const players = params.players || Array.from(document.querySelectorAll('input[name="selected_players"]:checked')).map(cb => gameState.players.find(p=>p.id==cb.value));
                players.forEach(pl => {
                    if(pl){
                        triggerEffect({
                            id: 'trening_koltseg', 
                            name: 'Tr√©ning (Tanul√°s)', 
                            type: 'duration', 
                            duration: d, 
                            startOffset: o, 
                            description: 'Nem hal√°szhat.', 
                            annoLabel: `Tr√©ningen (${pl.name})`, 
                            targets: [pl.id], 
                            color: annotationColors.playerNeutral, 
                            icon: effectIcons.neutral 
                        });
                        triggerEffect({
                            id: 'trening_bonusz', 
                            name: 'Tr√©ning (B√≥nusz)', 
                            type: 'duration', 
                            duration: d, 
                            description: `Fog√°s √©rt√©ke: ${GAME_CONFIG.CATCH_VALUE.TRAINING_BONUS}x`, 
                            annoLabel: `B√≥nusz (${pl.name})`, 
                            targets: [pl.id], 
                            color: annotationColors.playerGood, 
                            icon: effectIcons.positive, 
                            startOffset: o + d 
                        });
                    }
                });
                hideModal('chaos-modal');
            }
        },
    ];
const marketCards = [
        { id:'none', name:"V√°lassz piaci hat√°st..."}, { id:'random', name:"V√©letlen esem√©ny"},
        { id:'aszaly', name:'Asz√°ly', description:`Szaporulat: ${GAME_CONFIG.DROUGHT_REPRODUCTION_RATE}x (${GAME_CONFIG.POND_REPRODUCTION_RATE}x helyett)`, hasDuration: true, color: annotationColors.globalBad, icon: effectIcons.negative },
        { id:'fertozes', name:'Fert≈ëz√©s', description:`Fog√°s √©rt√©ke: ${GAME_CONFIG.CATCH_VALUE.INFECTION*100}%`, hasDuration: true, color: annotationColors.globalBad, icon: effectIcons.negative },
        { id:'hosszu_tel', name:'Hossz√∫ T√©l', description:"Befagy a t√≥, nincs hal√°szat.", hasDuration: true, color: annotationColors.globalBad, icon: effectIcons.negative },
        { id:'boom', name:"Luxuscikk-boom", description:`Fog√°s √©rt√©ke: ${GAME_CONFIG.CATCH_VALUE.BOOM}x`, hasDuration: true, color: annotationColors.globalGood, icon: effectIcons.positive },
        { id:'dumping', name:"D√∂mping √°rak", description:`Fog√°s √©rt√©ke: ${GAME_CONFIG.CATCH_VALUE.DUMPING*100}%`, hasDuration: true, color: annotationColors.globalBad, icon: effectIcons.negative },
        { id:'decree', name:"√öj kir√°lyi rendelet", description:"Fix k√∂lts√©g: +1", hasDuration: true, color: annotationColors.globalBad, icon: effectIcons.negative },
        { id:'swarm', name:"V√°ndor raj", description:"A t√≥hoz +50 hal ad√≥dik.", isInstant: true, color: annotationColors.globalGood, icon: effectIcons.positive },
        { id:'vihar', name:"Vihar", description:`Fog√°si k√≠s√©rlet hat√©konys√°ga: ${GAME_CONFIG.STORM_CATCH_MODIFIER*100}%`, hasDuration: true, color: annotationColors.globalBad, icon: effectIcons.negative },
    ];

    function hasEffect(playerId, effectId) { 
        return gameState.effectHistory.some(e => {
            const start = e.roundTriggered + (e.startOffset || 0);
            return e.id === effectId && 
                   (e.targets.includes('global') || e.targets.includes(playerId)) &&
                   e.type === 'duration' &&
                   gameState.round >= start &&
                   gameState.round <= (start + e.duration - 1);
        }); 
    }
    
    function getActiveEffectModifier(playerId, effectIdPrefix) {
      let totalModifier = 0;
      gameState.effectHistory.forEach(e => {
        const start = e.roundTriggered + (e.startOffset || 0);
        if (e.id.startsWith(effectIdPrefix) &&
            (e.targets.includes('global') || e.targets.includes(playerId)) &&
            e.type === 'duration' &&
            gameState.round >= start &&
            gameState.round <= (start + e.duration - 1) &&
            e.modifier) {
          totalModifier += parseInt(e.modifier);
        }
      });
      return totalModifier;
    }

    function populateChaosCards(){ dom.chaosCardSelect.innerHTML=''; chaosCards.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=c.title; dom.chaosCardSelect.appendChild(o); }); }
    function populateMarketCards(){ dom.marketCardSelect.innerHTML=''; marketCards.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=c.name; dom.marketCardSelect.appendChild(o); }); }
    function getFixedCost(n){ return GAME_CONFIG.FIXED_COSTS[n] || 3; }

    function initializeCharts(){
      if(playerWealthChart) playerWealthChart.destroy(); if(pondHistoryChart) pondHistoryChart.destroy(); if(playerWealthHistoryChart) playerWealthHistoryChart.destroy(); if(catchHistoryChart) catchHistoryChart.destroy();
      const onHover = (e, legendItem, legend) => {
        legend.chart.data.datasets.forEach((dataset, index) => {
          if (index !== legendItem.datasetIndex) {
            dataset.backgroundColor = dataset.backgroundColor.length > 7 ? dataset.backgroundColor.slice(0, 7) + '33' : dataset.backgroundColor + '33';
            dataset.borderColor = dataset.borderColor.length > 7 ? dataset.borderColor.slice(0, 7) + '33' : dataset.borderColor + '33';
          }
        });
        legend.chart.update();
      };
      const onLeave = (e, legendItem, legend) => {
        legend.chart.data.datasets.forEach((dataset, index) => {
            dataset.backgroundColor = playerColors[index % playerColors.length];
            dataset.borderColor = playerColors[index % playerColors.length];
        });
        legend.chart.update();
      };

      playerWealthChart = new Chart(document.getElementById('player-wealth-chart').getContext('2d'), { type:'bar', data:{ labels:[], datasets:[{ label:'Halak sz√°ma', data:[], backgroundColor:[] }] }, options:{ indexAxis:'y', maintainAspectRatio:false, scales:{ x:{ beginAtZero:true }}, plugins:{ legend:{ display:false }}} });
      const pondOptions = { maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, max:120 }}, plugins:{ legend:{ display:false }, annotation: { annotations:{} } } };
      pondHistoryChart = new Chart(document.getElementById('pond-history-chart').getContext('2d'), { type:'line', data:{ labels:[], datasets:[{ label:'Halak a t√≥ban', data:[], borderColor:'#54BFB2', tension:0.12, fill:true, backgroundColor:'rgba(84,191,178,0.18)' }] }, options: pondOptions });
      playerWealthHistoryChart = new Chart(document.getElementById('player-wealth-history-chart').getContext('2d'), { type:'line', data:{ labels:[], datasets:[] }, options:{ maintainAspectRatio:false, scales:{ y:{ beginAtZero:true }}, plugins:{ legend:{ position:'bottom', onHover, onLeave } } } });
      catchHistoryChart = new Chart(document.getElementById('catch-history-chart').getContext('2d'), { type:'bar', data:{ labels:[], datasets:[] }, options:{ maintainAspectRatio:false, scales:{ x:{ stacked:true }, y:{ stacked:true, beginAtZero:true }}, plugins:{ legend:{ position:'bottom', onHover, onLeave }, tooltip:{ callbacks:{ 
          title: (items) => { let total = 0; items[0].chart.data.datasets.forEach(ds => { total += ds.data[items[0].dataIndex] || 0; }); return `${items[0].label} - √ñsszes fog√°s: ${total}`; },
          label: (item) => { let total = 0; item.chart.data.datasets.forEach(ds => { total += ds.data[item.dataIndex] || 0; }); const percentage = total > 0 ? ((item.raw / total) * 100).toFixed(1) : 0; return `${item.dataset.label}: ${item.raw} hal (a napi fog√°s ${percentage} %-a)`; },
          footer:(items)=>{ let s=0; items.forEach(i=>s+=i.parsed.y); return '√ñsszesen: '+s; }
      }}} } });
    }

    function initGame(){
      const pc = parseInt(dom.playerCountInput.value);
      if(pc<4 || pc>10){ alert('A hal√°szok sz√°ma 4 √©s 10 k√∂z√∂tt lehet.'); return; }
      undoStack = []; updateUndoButton();
      gameState = {
        round: 1, pond: 100, bank: 0, fixedCost: getFixedCost(pc), maxPond: 100,
        pondHealth: 100,
        players: Array.from({length:pc}, (_,i)=>({ 
            id:i+1, name:`Hal√°sz #${i+1}`, fish:0, 
            reputation: 0, isBankrupt:false, 
            adjustments: [],
            history:{ wealth:[0], catch:[0] } 
        })),
        history: { pond:[100], sustainability:[] }, 
        log: [], effectHistory: [], annotations: [],
        advisorHistory: {}, auditLog: [],
        pollutedWater: { enabled: false, consecOver: 0, armedAtRound: null, activeFromRound: null, multiplier: 1.0, }
      };
      logEvent(`√öj j√°t√©k indult ${pc} j√°t√©kossal.`);
      dom.dailyAnalysisDisplay.innerHTML = "A kaland elkezd≈ëd√∂tt. Az els≈ë napon a k√∂z√∂ss√©g felm√©ri a lehet≈ës√©geit.";
      initializeCharts(); setupPlayerInputs(); updateAllUI();
      renderDebriefingTable(); // v8.9
      dom.setupScreen.classList.add('hidden'); dom.gameScreen.classList.remove('hidden');
    }
    
    function updateAllUI() { 
        if (!gameState || !gameState.players) return; 
        updateDisplay(gameState); 
        renderActiveEffectsPanel();
        updateAdvisorPanel();
        updateCharts(gameState); 
        updateAnalyticsPanels(); 
        updateStatCardHighlights();
        renderDebriefingTable(); // v8.9
        renderLog(); 
        renderAuditLog();
    }
    
    function getReputationIcon(reputation) {
        if (reputation > 2) return { icon: 'üòá', title: 'P√©ldamutat√≥' };
        if (reputation > 0) return { icon: 'üòä', title: 'Egy√ºttm≈±k√∂d≈ë' };
        if (reputation === 0) return { icon: 'üòê', title: 'Semleges' };
        if (reputation > -3) return { icon: 'üò†', title: '√ñnz≈ë' };
        return { icon: 'üòà', title: 'K√∂zellens√©g' };
    }

    function setupPlayerInputs(){
      dom.playerInputsContainer.innerHTML=''; if(!gameState.players) return;
      gameState.players.forEach(p=>{
        const wrap = document.createElement('div');
        const statuses = gameState.effectHistory.filter(e => {
            const start = e.roundTriggered + (e.startOffset || 0);
            return e.type === 'duration' && e.targets.includes(p.id) && gameState.round >= start && gameState.round <= (start + e.duration - 1);
        }).map(e => e.name.split('(')[0].trim());

        const rep = getReputationIcon(p.reputation);
        // DISZKR√âT VAGYON: Az ikon kattinthat√≥v√° t√©tele
        const reputationIcon = `<span title="H√≠rn√©v: ${rep.title} (Kattints a vagyon megtekint√©s√©hez!)" class="player-rep-icon" data-player-id="${p.id}">${rep.icon}</span>`;

        let labelContent = `${reputationIcon}<span class="player-name-span ${p.isBankrupt?'opacity-60':''}" data-player-id="${p.id}" style="color:${p.isBankrupt?'#9aa5b1':'var(--text)'}; cursor:pointer;">${p.name}</span>`;
        if(statuses.length>0) labelContent += `<span class="text-xs font-semibold ml-2" style="color:var(--c-turq)">(${statuses.join(', ')})</span>`;
        const label = document.createElement('label'); label.className = "flex justify-between items-center text-sm font-medium"; label.innerHTML = labelContent;
        if (p.isBankrupt) { const reviveBtn = document.createElement('button'); reviveBtn.className = "text-xs px-2 py-1 rounded-lg"; reviveBtn.style = "background: var(--c-turq); color:#0b1a2c"; reviveBtn.textContent = "Visszahoz√°s"; reviveBtn.onclick = () => revivePlayer(p.id); label.appendChild(reviveBtn); }
        wrap.appendChild(label); const input = document.createElement('input'); input.setAttribute('aria-label', `${p.name} fog√°s`); input.type = 'number'; input.id = `player-${p.id}-catch`; input.dataset.playerId = p.id; input.min = '0'; input.placeholder = '0'; input.className = "player-catch-input mt-1 block w-full rounded-xl border shadow-sm p-2 placeholder-slate-400"; input.style = "border-color: var(--border); background: rgba(255,255,255,.9); color:var(--text);";
        input.disabled = p.isBankrupt || hasEffect(p.id, 'beteg_halasz') || hasEffect(p.id, 'trening_koltseg') || hasEffect('global', 'hosszu_tel');
        
        input.addEventListener('input', checkBankruptcyWarning);
        
        wrap.appendChild(input); dom.playerInputsContainer.appendChild(wrap);
      });
      populateDivinePlayerSelector(); // v8.10
      const first = dom.playerInputsContainer.querySelector('input[type="number"]:not(:disabled)'); if(first) first.focus();
    }
    
    // DISZKR√âT VAGYON: √öj funkci√≥ a vagyon megjelen√≠t√©s√©re
    function showPlayerWealth(playerId) {
        const player = gameState.players.find(p => p.id === playerId);
        if (!player) return;
        dom.playerWealthTitle.textContent = player.name;
        dom.playerWealthAmount.textContent = Math.floor(player.fish);
        showModal('player-wealth-modal');
    }
    
    function revivePlayer(id){
      const p = gameState.players.find(x => x.id === id);
      if(p && p.isBankrupt){ 
        p.isBankrupt = false; p.fish = 0; p.reputation = 0; p.adjustments = [];
        triggerEffect({ id: 'rehab_ado', name: 'Rehabilit√°ci√≥s Ad√≥', type: 'duration', duration: GAME_CONFIG.BANKRUPTCY_REHAB_TAX.DURATION, description: `Fix k√∂lts√©g: +${GAME_CONFIG.BANKRUPTCY_REHAB_TAX.AMOUNT}`, annoLabel: `Extra ad√≥ (${p.name})`, targets: [p.id], color: annotationColors.playerBad, icon: effectIcons.player, startOffset: 1 });
        logEvent(`${p.name} visszat√©rt a j√°t√©kba. A k√∂vetkez≈ë napt√≥l ${GAME_CONFIG.BANKRUPTCY_REHAB_TAX.DURATION} napon √°t +${GAME_CONFIG.BANKRUPTCY_REHAB_TAX.AMOUNT} ad√≥t fizet.`); 
        setupPlayerInputs(); updateCharts(gameState); 
      }
    }

    function checkBankruptcyWarning(event) {
        const input = event.target;
        const playerId = parseInt(input.dataset.playerId);
        const player = gameState.players.find(p => p.id === playerId);
        if (!player || player.isBankrupt) return;

        const attemptedCatch = parseInt(input.value) || 0;
        const actualCatch = Math.floor(attemptedCatch * (hasEffect('global', 'vihar') ? GAME_CONFIG.STORM_CATCH_MODIFIER : 1));
        
        const income = calculatePlayerIncome(player, actualCatch);
        const { totalCost } = calculatePlayerCost(player);
        
        const expectedWealth = player.fish + income.total - totalCost;

        if (expectedWealth < 0) {
            input.classList.add('bankruptcy-warning');
        } else {
            input.classList.remove('bankruptcy-warning');
        }
    }

    function checkBankruptcyBeforeEndRound() {
        const potentialBankruptcies = [];
        
        gameState.players.forEach(p => {
            if (p.isBankrupt) return;

            const inputEl = document.getElementById(`player-${p.id}-catch`);
            const attemptedCatch = parseInt(inputEl.value) || 0;
            const actualCatch = Math.floor(attemptedCatch * (hasEffect('global', 'vihar') ? GAME_CONFIG.STORM_CATCH_MODIFIER : 1));

            const income = calculatePlayerIncome(p, actualCatch);
            const { totalCost } = calculatePlayerCost(p);
            
            const expectedWealth = p.fish + income.total - totalCost;
            
            if (expectedWealth < 0) {
                potentialBankruptcies.push(p.name);
            }
        });

        if (potentialBankruptcies.length > 0) {
            const playerList = potentialBankruptcies.join('\n - ');
            return confirm(`FIGYELEM!\n\nA k√∂vetkez≈ë j√°t√©kos(ok) cs≈ëdbe fognak menni:\n - ${playerList}\n\nBiztosan lez√°rod a napot?`);
        }
        
        return true;
    }


    function endRound() {
        if (!checkBankruptcyBeforeEndRound()) {
            return;
        }

        saveStateForUndo();
        const pondBefore = gameState.pond;
        const playerActions = gatherPlayerInputs();
        const totalCatch = playerActions.reduce((sum, p) => sum + p.actual, 0);

        if (totalCatch > pondBefore) {
            alert(`Hiba: √ñsszesen ${totalCatch} halat fogn√°tok, de csak ${Math.floor(pondBefore)} van!`);
            return;
        }

        const metrics = calculateRoundMetrics(pondBefore, totalCatch);
        logRoundSummary(totalCatch, metrics.mff, pondBefore);
        updateSustainabilityHistory(totalCatch, metrics.mff);
        
        updatePollutedWaterStatus(metrics.overfishing);
        updatePondHealth(metrics.overfishing);
        updateAllPlayerStates(playerActions, metrics);
        applyPondRegeneration(metrics.regen);
        
        const analysis = generateDailyAnalysis();
        dom.dailyAnalysisDisplay.innerHTML = analysis;
        
        prepareNextRound();
    }

    function saveStateForUndo() {
        undoStack.push(structuredClone(gameState));
        if (undoStack.length > 20) undoStack.shift();
        updateUndoButton();
    }

    function gatherPlayerInputs() {
        const actions = [];
        const stormModifier = hasEffect('global', 'vihar') ? GAME_CONFIG.STORM_CATCH_MODIFIER : 1;
        gameState.players.forEach(p => {
            const inputEl = document.getElementById(`player-${p.id}-catch`);
            const attemptedCatch = parseInt(inputEl.value) || 0;
            if (!p.isBankrupt && !hasEffect(p.id, 'beteg_halasz') && !hasEffect(p.id, 'trening_koltseg') && !hasEffect('global', 'hosszu_tel')) {
                const actualCatch = Math.floor(attemptedCatch * stormModifier);
                actions.push({ id: p.id, attempted: attemptedCatch, actual: actualCatch });
            } else {
                actions.push({ id: p.id, attempted: 0, actual: 0 });
            }
        });
        return actions;
    }

    function calculateRoundMetrics(pondBefore, totalCatch) {
        const season = getCurrentSeason(gameState.round);
        let baseRegen = season.regenModifier;
        if (hasEffect('global', 'aszaly')) baseRegen = GAME_CONFIG.DROUGHT_REPRODUCTION_RATE;
        if (hasEffect('global', 'divine_regen')) baseRegen = parseFloat(gameState.effectHistory.find(e => e.id === 'divine_regen').modifier) || baseRegen;

        const pw = gameState.pollutedWater;
        if (pw.enabled && pw.activeFromRound !== null) {
            baseRegen *= pw.multiplier;
        }
        const mff = Math.max(0, pondBefore - (gameState.maxPond / baseRegen));
        const overfishing = totalCatch - mff;
        return { regen: baseRegen, mff, overfishing };
    }
    
    function updatePollutedWaterStatus(overfishing) {
        const pw = gameState.pollutedWater; if (!pw.enabled) return;
        if (pw.activeFromRound !== null) {
            if (overfishing > 0) {
                if (pw.multiplier > GAME_CONFIG.POLLUTED_WATER.MIN_MULTIPLIER) {
                    logEvent('Visszaes√©s! A t√≥ regener√°ci√≥ja a minimumra cs√∂kkent a t√∫lhal√°szat miatt.');
                    pw.multiplier = GAME_CONFIG.POLLUTED_WATER.MIN_MULTIPLIER;
                }
            } else {
                if (pw.multiplier < 1.0) {
                    pw.multiplier = Math.min(1.0, pw.multiplier + GAME_CONFIG.POLLUTED_WATER.RECOVERY_STEP);
                    logEvent(`A t√≥ gy√≥gyul. Regener√°ci√≥s szorz√≥: ${pw.multiplier.toFixed(1)}x.`);
                }
            }
        } else {
            if (overfishing > 0) { pw.consecOver++; } else { pw.consecOver = 0; }
            if (pw.armedAtRound === null && pw.consecOver >= GAME_CONFIG.POLLUTED_WATER.ARM_THRESHOLD) {
                pw.armedAtRound = gameState.round;
                logEvent(`A t√≥ t√∫lterhelt! A Szennyezett V√≠z rendszer ${GAME_CONFIG.POLLUTED_WATER.START_DELAY} nap m√∫lva aktiv√°l√≥dik, ha folytat√≥dik a t√∫lhal√°szat.`);
            }
            if (pw.consecOver === 0) { pw.armedAtRound = null; }
            if (pw.armedAtRound !== null && gameState.round >= pw.armedAtRound + GAME_CONFIG.POLLUTED_WATER.START_DELAY) {
                pw.activeFromRound = gameState.round; pw.multiplier = GAME_CONFIG.POLLUTED_WATER.MIN_MULTIPLIER;
                logEvent('AKTIV√ÅL√ìDOTT A SZENNYEZETT V√çZ! A t√≥ regener√°ci√≥ja drasztikusan lecs√∂kkent.');
                addAnnotation(`Szennyezett V√≠z AKT√çV (Regen √ó${pw.multiplier.toFixed(1)})`, 1, annotationColors.globalBad);
            }
        }
    }
    
    function logRoundSummary(totalCatch, mff, pondBefore) { logEvent(`${getFullDay(gameState.round)}: ${totalCatch} hal kifogva (fenntarthat√≥: ${Math.floor(mff)}). T√≥: ${Math.floor(pondBefore)}.`); }
    function updateSustainabilityHistory(totalCatch, mff) { 
        const validCatch = isNaN(totalCatch) ? 0 : totalCatch;
        const validMff = isNaN(mff) ? 0 : mff;
        gameState.history.sustainability.push({ round: gameState.round, mff: validMff, actualCatch: validCatch }); 
    }

    function updatePondHealth(overfishing) {
        if (overfishing > 0) {
            const healthChange = Math.min(Math.ceil(overfishing / GAME_CONFIG.POND_HEALTH.OVERFISHING_PENALTY_DIVISOR), GAME_CONFIG.POND_HEALTH.MAX_PENALTY_PER_ROUND);
            gameState.pondHealth -= healthChange;
        } else {
            const bonusRecovery = Math.abs(overfishing) * GAME_CONFIG.POND_HEALTH.RECOVERY_BONUS_FACTOR;
            const totalRecovery = GAME_CONFIG.POND_HEALTH.RECOVERY_PER_ROUND + bonusRecovery;
            gameState.pondHealth += totalRecovery;
            if (bonusRecovery > 0) {
                logEvent(`Fenntarthat√≥ hal√°szat! A t√≥ eg√©szs√©ge b√≥nusz ${bonusRecovery.toFixed(1)} ponttal javult (√∂sszesen: ${totalRecovery.toFixed(1)}).`);
            }
        }
        gameState.pondHealth = Math.max(0, Math.min(100, gameState.pondHealth));
    }
    
    function updateAllPlayerStates(playerActions, metrics) {
        const activePlayersCount = gameState.players.filter(p => !p.isBankrupt).length;
        const fairShare = activePlayersCount > 0 ? metrics.mff / activePlayersCount : 0;
        
        playerActions.forEach(action => {
            const player = gameState.players.find(p => p.id === action.id);
            if (!player) return;

            const wealthStart = player.fish;
            const reputationStart = player.reputation;
            
            const income = calculatePlayerIncome(player, action.actual);
            const { totalCost, costDetails } = calculatePlayerCost(player);
            
            player.fish += income.total;
            if (!player.isBankrupt) { player.fish -= totalCost; gameState.bank += totalCost; }
            
            updatePlayerReputation(player, action.actual, fairShare);
            const wealthEnd = player.fish;
            
            const adjustments = processPlayerAdjustments(player);
            createAuditEntry({player, action, wealthStart, reputationStart, income, costs: {total: totalCost, details: costDetails}, adjustments, fairShare, wealthEnd, mff: metrics.mff, totalCatch: playerActions.reduce((sum,p)=>sum+p.actual,0) });
            
            checkPlayerBankruptcy(player);
            player.history.wealth.push(player.fish);
            player.history.catch.push(action.actual);
            gameState.pond -= action.actual;
        });
    }

    function calculatePlayerIncome(player, fishCaught) {
        let valueModifier = GAME_CONFIG.CATCH_VALUE.DEFAULT;
        const details = ['Alap√©rt√©k: 1x'];
        if (hasEffect('global', 'fertozes')) { valueModifier *= GAME_CONFIG.CATCH_VALUE.INFECTION; details.push(`Fert≈ëz√©s: ${GAME_CONFIG.CATCH_VALUE.INFECTION}x`); }
        if (hasEffect('global', 'boom')) { valueModifier *= GAME_CONFIG.CATCH_VALUE.BOOM; details.push(`Luxus Boom: ${GAME_CONFIG.CATCH_VALUE.BOOM}x`); }
        if (hasEffect('global', 'dumping')) { valueModifier *= GAME_CONFIG.CATCH_VALUE.DUMPING; details.push(`D√∂mping: ${GAME_CONFIG.CATCH_VALUE.DUMPING}x`); }
        if (hasEffect(player.id, 'trening_bonusz')) { valueModifier *= GAME_CONFIG.CATCH_VALUE.TRAINING_BONUS; details.push(`Tr√©ning B√≥nusz: ${GAME_CONFIG.CATCH_VALUE.TRAINING_BONUS}x`); }
        return { total: fishCaught * valueModifier, modifier: valueModifier, details };
    }

    function updatePlayerReputation(player, fishCaught, fairShare) {
        if (!player.isBankrupt) {
            if (fishCaught > fairShare * GAME_CONFIG.REPUTATION.OVERFISHING_THRESHOLD && fairShare > 0) player.reputation -= GAME_CONFIG.REPUTATION.CHANGE_VALUE;
            if (fishCaught < fairShare * GAME_CONFIG.REPUTATION.UNDERFISHING_THRESHOLD) player.reputation += GAME_CONFIG.REPUTATION.CHANGE_VALUE;
            player.reputation = Math.max(GAME_CONFIG.REPUTATION.MIN_VALUE, Math.min(GAME_CONFIG.REPUTATION.MAX_VALUE, player.reputation));
        }
    }
    
    function processPlayerAdjustments(player) {
        if (!player.adjustments || player.adjustments.length === 0) {
            return { total: 0, details: '' };
        }
        const total = player.adjustments.reduce((sum, adj) => sum + adj.amount, 0);
        const details = player.adjustments.map(adj => `${adj.details}: ${adj.amount}`).join('; ');
        player.adjustments = [];
        return { total, details };
    }

    function calculatePlayerCost(player) {
        const costDetails = []; let totalCost = 0;
        const season = getCurrentSeason(gameState.round);
        if (hasEffect(player.id, 'kiralyi_kedvezmeny')) { costDetails.push('Kir√°lyi Kedvezm√©ny: mentess√©g'); return {totalCost: 0, costDetails}; }
        
        if (hasEffect('global', 'kozossegi_hozzajarulas')) {
            if (player.fish < GAME_CONFIG.PROGRESSIVE_TAX.WEALTH_TIER_1) totalCost = GAME_CONFIG.PROGRESSIVE_TAX.TAX_TIER_1;
            else if (player.fish <= GAME_CONFIG.PROGRESSIVE_TAX.WEALTH_TIER_2) totalCost = GAME_CONFIG.PROGRESSIVE_TAX.TAX_TIER_2;
            else totalCost = Math.ceil(player.fish * GAME_CONFIG.PROGRESSIVE_TAX.TAX_TIER_3_RATE);
            costDetails.push(`Progressz√≠v ad√≥: ${totalCost}`);
        } else {
            let baseCost = gameState.fixedCost; costDetails.push(`Alap fix k√∂lts√©g: ${baseCost}`);
            if (hasEffect(player.id, 'kiralyi_ado')) { const extra = baseCost; baseCost += extra; costDetails.push(`Kir√°lyi Ad√≥ (2x): +${extra}`); }
            if (hasEffect(player.id, 'rehab_ado')) { baseCost += GAME_CONFIG.BANKRUPTCY_REHAB_TAX.AMOUNT; costDetails.push(`Rehab. ad√≥: +${GAME_CONFIG.BANKRUPTCY_REHAB_TAX.AMOUNT}`); }
            if (hasEffect('global', 'decree')) { baseCost += 1; costDetails.push(`Rendelet: +1`); }
            // C√©lzott ad√≥ (v8.10)
            if (hasEffect(player.id, 'divine_tax')) { 
                const mod = getActiveEffectModifier(player.id, 'divine_tax');
                baseCost += mod; 
                costDetails.push(`Isteni beavatkoz√°s: ${mod > 0 ? '+' : ''}${mod}`); 
            }
            if (season.costModifier > 0) { baseCost += season.costModifier; costDetails.push(`${season.name} extra k√∂lts√©g: +${season.costModifier}`); }
            totalCost = baseCost;
        }

        const familyAffairMod = getActiveEffectModifier(player.id, 'csaladi_ugyek_effect');
        if (familyAffairMod !== 0) {
            totalCost += familyAffairMod;
            costDetails.push(`Csal√°di √ºgyek: ${familyAffairMod > 0 ? '+' : ''}${familyAffairMod}`);
        }

        if (hasEffect(player.id, 'beteg_halasz') || hasEffect(player.id, 'trening_koltseg')) { totalCost = gameState.fixedCost; costDetails.splice(0, costDetails.length, `Betegs√©g/Tr√©ning alapd√≠j: ${totalCost}`); }
        return { totalCost, costDetails };
    }
function createAuditEntry({player, action, wealthStart, reputationStart, income, costs, adjustments, fairShare, wealthEnd, mff, totalCatch}) {
        const entry = {
            round: gameState.round,
            roundData: { pondStart: gameState.history.pond[gameState.history.pond.length-1], mff, totalCatch },
            playerId: player.id,
            playerName: player.name,
            wealthStart: Math.floor(wealthStart),
            catch: { attempted: action.attempted, actual: action.actual },
            income: { total: Math.round(income.total), details: income.details.join(', ') },
            costs: { total: costs.total, details: costs.details.join(', ') },
            adjustments: { total: adjustments.total, details: adjustments.details },
            reputationChange: player.reputation - reputationStart,
            fairShare: Math.round(fairShare),
            wealthEnd: Math.floor(wealthEnd)
        };
        gameState.auditLog.push(entry);
    }

    function checkPlayerBankruptcy(player) { if (!player.isBankrupt && player.fish < 0) { alert(`${player.name} cs≈ëdbe ment!`); player.isBankrupt = true; player.fish = 0; logEvent(`${player.name} cs≈ëdbe ment.`); } }
    function applyPondRegeneration(regenRate) { gameState.pond = Math.min(gameState.maxPond, gameState.pond * regenRate); gameState.history.pond.push(gameState.pond); }

    function prepareNextRound() {
        gameState.round++;
        setupPlayerInputs();
        document.querySelectorAll('.player-catch-input').forEach(input => input.classList.remove('bankruptcy-warning'));
        
        gameState.players.forEach(p => {
            const inputElement = document.getElementById(`player-${p.id}-catch`);
            if (inputElement) inputElement.value = '';
        });
        updateAllUI();
    }
    
    function undoLastRound() { if (undoStack.length === 0) return; gameState = undoStack.pop(); logEvent("--- UTOLS√ì NAP VISSZAVONVA ---", { isDetail: true }); setupPlayerInputs(); updateAllUI(); updateUndoButton(); }
    function updateUndoButton() { dom.undoBtn.disabled = undoStack.length === 0; }

    function updateAnalyticsPanels(){
      dom.sustainabilityTableBody.innerHTML=''; if(!gameState.history) return;
      [...gameState.history.sustainability].reverse().forEach(s=>{
        const diff = s.mff - s.actualCatch;
        const row = `<tr class="border-b" style="background: rgba(255,255,255,0.7); border-color: var(--border);"><td class="px-6 py-3">${getFullDay(s.round)}</td><td class="px-6 py-3">${Math.floor(s.mff)}</td><td class="px-6 py-3">${s.actualCatch}</td><td class="px-6 py-3 font-bold" style="color:${diff<0? 'var(--c-red)':'#227a66'}">${diff>0?'+':''}${Math.floor(diff)}</td></tr>`;
        dom.sustainabilityTableBody.insertAdjacentHTML('beforeend', row);
      });
    }

    // === v8.9 √öJ FUNKCI√ì ===
    function renderDebriefingTable() {
        if (!dom.debriefTableBody || !gameState.players) return;

        let bodyHtml = '';
        let totalGameCatch = 0;
        let totalGameRep = 0;
        let totalGameOverfishing = 0;
        let totalGameCost = 0;
        let totalGameWealth = 0;

        gameState.auditLog.forEach(entry => {
            totalGameCatch += entry.catch.actual;
        });

        gameState.players.forEach(player => {
            let playerCatch = 0;
            let playerRep = 0;
            let playerOverfishing = 0;
            let playerCost = 0;

            gameState.auditLog.forEach(entry => {
                if (entry.playerId === player.id) {
                    playerCatch += entry.catch.actual;
                    playerRep += entry.reputationChange;
                    playerOverfishing += (entry.catch.actual - entry.fairShare);
                    playerCost += entry.costs.total;
                }
            });

            const catchPercent = totalGameCatch > 0 ? (playerCatch / totalGameCatch * 100) : 0;
            const overfishClass = playerOverfishing < 0 ? 'col-overfish-pos' : (playerOverfishing > 0 ? 'col-overfish-neg' : '');
            const overfishSign = playerOverfishing > 0 ? '+' : '';
            const repSign = playerRep > 0 ? '+' : '';
            const status = player.isBankrupt ? '<span class="text-xs font-bold" style="color:var(--c-red)">CS≈êD</span>' : '<span class="text-xs font-bold" style="color:var(--c-turq)">Akt√≠v</span>';

            bodyHtml += `
                <tr>
                    <td>${player.name}</td>
                    <td>${status}</td>
                    <td class="col-wealth">${Math.floor(player.fish)}</td>
                    <td>${catchPercent.toFixed(1)}% (${playerCatch})</td>
                    <td class="${overfishClass}">${overfishSign}${Math.floor(playerOverfishing)}</td>
                    <td>${repSign}${playerRep}</td>
                    <td>${playerCost}</td>
                </tr>
            `;

            totalGameOverfishing += playerOverfishing;
            totalGameRep += playerRep;
            totalGameCost += playerCost;
            if (!player.isBankrupt) {
                totalGameWealth += player.fish;
            }
        });

        dom.debriefTableBody.innerHTML = bodyHtml;

        dom.debriefTableFoot.innerHTML = `
            <tr>
                <td>√ñSSZESEN</td>
                <td>-</td>
                <td class="col-wealth">${Math.floor(totalGameWealth)}</td>
                <td>100% (${totalGameCatch})</td>
                <td>${totalGameOverfishing > 0 ? '+' : ''}${Math.floor(totalGameOverfishing)}</td>
                <td>${totalGameRep > 0 ? '+' : ''}${totalGameRep}</td>
                <td>${totalGameCost}</td>
            </tr>
        `;
    }
    // === v8.9 V√âGE ===

    // === v8.10 √öJ FUNKCI√ìK START ===
    function populateDivinePlayerSelector() {
        if (!dom.divinePlayerSelector || !gameState.players) return;
        dom.divinePlayerSelector.innerHTML = '';
        gameState.players.forEach(p => {
            const label = document.createElement('label');
            label.className = `flex items-center gap-1.5 ${p.isBankrupt ? 'opacity-50' : ''}`;
            label.innerHTML = `<input type="checkbox" name="divine_target" value="${p.id}" class="rounded divine-target-player"> <span>${p.name}</span>`;
            dom.divinePlayerSelector.appendChild(label);
        });
        
        // Esem√©nykezel≈ëk a "Mindenki" √©s az egy√©ni checkboxok szinkroniz√°l√°s√°hoz
        const allCheckbox = document.getElementById('divine-target-all');
        const playerCheckboxes = document.querySelectorAll('.divine-target-player');

        allCheckbox.addEventListener('change', () => {
            playerCheckboxes.forEach(cb => cb.checked = allCheckbox.checked);
        });

        dom.divinePlayerSelector.addEventListener('change', (e) => {
            if (e.target.classList.contains('divine-target-player')) {
                if (!e.target.checked) {
                    allCheckbox.checked = false;
                } else {
                    allCheckbox.checked = Array.from(playerCheckboxes).every(cb => cb.checked);
                }
            }
        });
    }

    function getDivineTargets() {
        const selectedPlayers = Array.from(document.querySelectorAll('.divine-target-player:checked')).map(cb => parseInt(cb.value));
        
        if (selectedPlayers.length > 0) {
            return selectedPlayers; // Visszaadja a specifikus j√°t√©kosokat
        }
        
        // Ha senki nincs kiv√°lasztva (vagy a "Mindenki" volt bepip√°lva √©s az kezeli a t√∂bbieket),
        // akkor minden NEM cs≈ëdbe ment j√°t√©kost visszaadunk
        return gameState.players.filter(p => !p.isBankrupt).map(p => p.id);
    }
    // === v8.10 √öJ FUNKCI√ìK V√âGE ===

    function getPondHealthStatusText(health) {
        if (health > 80) return "Kiv√°l√≥";
        if (health > 50) return "Stabil";
        if (health > 25) return "S√©r√ºl√©keny";
        return "Kritikus";
    }

function updateDisplay(s){
      dom.endGameBtn.querySelector('span').innerHTML = `<svg class="w-4 h-4 opacity-90" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M3 5h18v2H3zM7 11h14v2H7zM11 17h10v2H11z"/></svg> ${getFullDay(s.round)} lez√°r√°sa`;
      dom.mainDayIndicator.textContent = getFullDay(s.round);
      const season = getCurrentSeason(s.round);
      dom.seasonIndicator.innerHTML = `${season.icon} ${season.name} <span class="text-sm opacity-80">(${season.description})</span>`;

      animateNumber(dom.pondStatusDisplay, Math.floor(s.pond)); 
      animateNumber(dom.bankStatusDisplay, Math.floor(s.bank));
      const seasonCost = season.costModifier > 0 ? `+${season.costModifier}` : '';
      dom.fixedCostDisplay.textContent = `${s.fixedCost}${seasonCost}`;
      
      const metrics = calculateRoundMetrics(s.pond, 0);
      const sustainableCatch = Math.floor(s.pond * (metrics.regen - 1) / metrics.regen); 
      const maxGrowthCatch = Math.floor(metrics.mff);
      animateNumber(dom.sustainableCatchDisplay, sustainableCatch); 
      animateNumber(dom.maxGrowthCatchDisplay, maxGrowthCatch);

      const health = s.pondHealth;
      animateNumber(dom.pondHealthDisplay, health, 420, '%');
      dom.pondHealthBar.style.width = health + '%';
      dom.pondHealthText.textContent = getPondHealthStatusText(health);
      
      // Grafikus bar √©s sz√∂veg sz√≠ne
      if (health <= 25) { dom.pondHealthBar.style.backgroundColor = 'var(--c-red)'; dom.pondHealthText.style.color = 'var(--c-red)'; }
      else if (health <= 50) { dom.pondHealthBar.style.backgroundColor = 'var(--c-gold)'; dom.pondHealthText.style.color = 'var(--c-gold)'; }
      else { dom.pondHealthBar.style.backgroundColor = 'var(--c-turq)'; dom.pondHealthText.style.color = 'var(--muted)'; }

      // === v8.8 Vesz√©lyz√≥na Kijelz≈ëk ===
      const healthCard = dom.pondHealthDisplay.closest('.status-card');
      const pondStatusCard = dom.pondStatusDisplay.closest('.status-card');
      
      // 1. T√≥ Eg√©szs√©ge k√°rtya
      healthCard.classList.remove('card-danger', 'card-caution');
      if (health <= 25) {
        healthCard.classList.add('card-danger');
      } else if (health <= 50) {
        healthCard.classList.add('card-caution');
      }
      
      // 2. Halak a t√≥ban k√°rtya
      pondStatusCard.classList.remove('card-danger', 'card-caution', 'card-warning'); // a r√©gi .card-warning-ot is t√∂r√∂lj√ºk
      if (s.pond <= 15) {
        pondStatusCard.classList.add('card-danger');
      } else if (s.pond <= 30) {
        pondStatusCard.classList.add('card-caution');
      }

      // 3. Fenntarthat√≥ Fog√°s (MFF) sz√∂veg
      dom.sustainableCatchDisplay.classList.remove('text-danger');
      if (sustainableCatch < 0) {
        dom.sustainableCatchDisplay.classList.add('text-danger');
      }
      
      // 4. Max. N√∂veked√©s Fog√°s (MMF) sz√∂veg
      dom.maxGrowthCatchDisplay.classList.remove('text-danger');
      if (maxGrowthCatch < 0) {
          dom.maxGrowthCatchDisplay.classList.add('text-danger');
      }
    }
    
    function updateStatCardHighlights() {
      const effectMap = {
        'decree': dom.fixedCostCard, 'divine_tax': dom.fixedCostCard, 'kiralyi_ado': dom.fixedCostCard,
        'csaladi_ugyek_effect': dom.fixedCostCard,
        'aszaly': dom.maxGrowthCatchCard, 'divine_regen': dom.maxGrowthCatchCard
      };
      
      Object.values(effectMap).forEach(el => el.classList.remove('card-highlight-active'));

      Object.keys(effectMap).forEach(effectId => {
        if (hasEffect('global', effectId) || gameState.players.some(p => hasEffect(p.id, effectId))) {
          effectMap[effectId].classList.add('card-highlight-active');
        }
      });
      if(getCurrentSeason(gameState.round).costModifier > 0) {
        dom.fixedCostCard.classList.add('card-highlight-active');
      }
    }

    function generateDailyAnalysis() {
        const { players, history, round } = gameState;
        const activePlayers = players.filter(p => !p.isBankrupt);
        if (activePlayers.length < 2) return "A k√∂z√∂ss√©g sorsa egyetlen hal√°sz kez√©ben van.";

        const lastSustain = history.sustainability[history.sustainability.length - 1];
        if (!lastSustain) return "Az els≈ë nap elemz√©se hamarosan...";
        const { mff, actualCatch } = lastSustain;
        const overfishing = actualCatch - mff;

        // 1. Critical Events
        const bankruptCount = players.length - activePlayers.length;
        if (bankruptCount > 0 && bankruptCount !== (players.length - activePlayers.length - 1)) {
            const newlyBankrupt = players.find(p => p.isBankrupt && p.history.wealth[round - 2] >= 0);
            return `üö® <strong>V√°ls√°g:</strong> ${newlyBankrupt ? newlyBankrupt.name : 'Egy hal√°sz'} cs≈ëdbe ment! A k√∂z√∂ss√©gnek reag√°lnia kell a cs√∂kken≈ë l√©tsz√°mra.`;
        }
        if (gameState.pond < 20) {
            return `üìâ <strong>√ñsszeoml√°s:</strong> A t√≥ hal√°llom√°nya kritikusan alacsony. A t√∫l√©l√©shez radik√°lis strat√©gi√°ra van sz√ºks√©g.`;
        }

        // 2. Community Performance
        if (overfishing < 0 && history.sustainability.length > 1 && history.sustainability[history.sustainability.length - 2].actualCatch > history.sustainability[history.sustainability.length - 2].mff) {
            return `‚úÖ <strong>Fordul√≥pont:</strong> A k√∂z√∂ss√©gnek egy t√∫lzott kihal√°sz√°s√∫ nap ut√°n el≈ësz√∂r siker√ºlt fenntarthat√≥an hal√°sznia. Ez rem√©nyt ad a j√∂v≈ëre.`;
        }
        if (overfishing < 0) {
            return `üå± <strong>Fenntarthat√≥s√°g:</strong> A k√∂z√∂ss√©g a mai napon ${Math.floor(Math.abs(overfishing))} hallal kevesebbet fogott a maxim√°lisn√°l, ezzel akt√≠van hozz√°j√°rultak a t√≥ gy√≥gyul√°s√°hoz.`;
        }

        // 3. Wealth & Catch Distribution
        const wealths = activePlayers.map(p => p.fish).sort((a, b) => a - b);
        const minWealth = wealths[0], maxWealth = wealths[wealths.length - 1];
        const ratio = maxWealth / (minWealth + 1);
        if (ratio > 5) {
            const richest = activePlayers.find(p => p.fish === maxWealth);
            return `‚öñÔ∏è <strong>Szakad√©k:</strong> A vagyoni k√ºl√∂nbs√©gek drasztikusan n≈ëttek. ${richest.name} vagyona m√°r t√∂bb mint √∂tsz√∂r√∂se a legszeg√©nyebb hal√°sz√©nak.`;
        }

        const catches = activePlayers.map(p => p.history.catch[p.history.catch.length - 1]);
        const topCatcher = Math.max(...catches);
        if (actualCatch > 0 && topCatcher / actualCatch > 0.5) {
            const topPlayer = activePlayers.find(p => p.history.catch[p.history.catch.length - 1] === topCatcher);
            return `üé£ <strong>Dominancia:</strong> A mai fog√°s t√∂bb mint fel√©t (${Math.round(topCatcher / actualCatch * 100)}%) egyetlen hal√°sz, ${topPlayer.name} hozta ki.`;
        }

        return "A k√∂z√∂ss√©g egy √°tlagos napot z√°rt, a megszokott ker√©kv√°g√°sban haladnak a dolgok.";
    }


    function getAdvisorSuggestions() {
        const suggestions = [];
        const { pondHealth, players, round, pollutedWater } = gameState;
        
        const recentlySuggested = (id) => { const last = gameState.advisorHistory[id]; return last && (round - last < 4); };
        const addSuggestion = (suggestion) => {
            const id = suggestion.cardId || suggestion.id;
            if (!recentlySuggested(id)) {
                suggestions.push(suggestion);
                gameState.advisorHistory[id] = round;
            }
        };
        
        if (pollutedWater.enabled && pollutedWater.armedAtRound !== null && pollutedWater.activeFromRound === null) {
            addSuggestion({
                id: 'warning_polluted_water_armed', type: 'warning',
                name: 'Figyelmeztet√©s: Rendszer-√∂sszeoml√°s k√∂zeleg!',
                justification: `A t√≥ regener√°ci√≥s rendszere t√∫lterhelt, ${GAME_CONFIG.POLLUTED_WATER.START_DELAY - (round - pollutedWater.armedAtRound)} nap van h√°tra a drasztikus roml√°sig.`,
                narrative: `A k√∂z√∂ss√©gnek azonnal be kell sz√ºntetnie a t√∫lhal√°szatot, k√ºl√∂nben a t√≥ √∂kosziszt√©m√°ja √∂sszeomlik, √©s a gy√≥gyul√°s rendk√≠v√ºl lass√∫ lesz.`
            });
        }
        if (pondHealth < 50 && pondHealth >= 30) {
            addSuggestion({
                id: 'warning_low_health', type: 'warning',
                name: 'Figyelmeztet√©s: Gyeng√ºl≈ë √∂kosziszt√©ma!',
                justification: `A t√≥ eg√©szs√©ge 50% al√° esett. A rendszer s√©r√ºl√©kenny√© v√°lt.`,
                narrative: `A v√≠z zavarosabb, a halak lassabban mozognak. Ha a tendencia folytat√≥dik, hamarosan betegs√©gek √ºthetik fel a fej√ºket.`
            });
        }
        
        if (pondHealth < 30) {
            addSuggestion({
                cardId: 'fertozes', cardType: 'market',
                name: 'Fert≈ëz√©s',
                justification: `A t√≥ eg√©szs√©ge kritikusan alacsony (${pondHealth}%).`,
                narrative: `A hal√°szok arra panaszkodnak, hogy a kifogott halak fele betegnek t≈±nik, √©s a piacon alig kapnak √©rt√ºk valamit.`
            });
        }

        const activePlayers = players.filter(p => !p.isBankrupt);
        if (activePlayers.length > 1) {
            const wealths = activePlayers.map(p => p.fish).sort((a, b) => a - b);
            const minWealth = wealths[0];
            const maxWealth = wealths[wealths.length - 1];
            if (minWealth >= 0 && maxWealth > 0) {
                const ratio = maxWealth / (minWealth + 1);
                if (ratio > 3 && ratio <= 4) {
                    addSuggestion({
                        id: 'warning_wealth_gap', type: 'warning',
                        name: 'Figyelmeztet√©s: N√∂vekv≈ë fesz√ºlts√©g!',
                        justification: `Jelent≈ës vagyoni szakad√©k kezd kialakulni (${Math.round(ratio)}x).`,
                        narrative: `A faluban egyre t√∂bbet suttognak a gazdagok √©s szeg√©nyek k√∂z√∂tti k√ºl√∂nbs√©gr≈ël. Ez a fesz√ºlts√©g konfliktusokhoz vezethet.`
                    });
                }
                if (ratio > 4) {
                    addSuggestion({
                        cardId: 'kiralyi_sarc', cardType: 'chaos',
                        name: 'Kir√°lyi Sarc',
                        justification: `Extr√©m vagyoni szakad√©k alakult ki (${Math.round(ratio)}x).`,
                        narrative: `A kir√°lyi h√≠rviv≈ë √ºzenetet hoz: a kir√°ly l√°tja a k√∂z√∂ss√©g gyarapod√°s√°t, √©s sarcot k√∂vetel, ami pr√≥b√°ra teszi a bels≈ë szolidarit√°st.`
                    });
                }
            }
        }
        
        const greedyPlayer = players.find(p => p.reputation <= -3);
        if (greedyPlayer) {
            addSuggestion({
                cardId: 'portyazok', cardType: 'chaos',
                name: 'Porty√°z√≥k',
                justification: `Egy vagy t√∂bb j√°t√©kos h√≠rneve nagyon alacsony (pl. ${greedyPlayer.name}: ${greedyPlayer.reputation}).`,
                narrative: `A k√∂rny√©ken porty√°z√≥k gar√°zd√°lkodnak. A pletyk√°k szerint a moh√≥, √∂nz≈ë hal√°szok h√≠vt√°k fel magukra a figyelmet, vesz√©lybe sodorva a k√∂z√∂ss√©get.`
            });
        }
        
        const totalReputation = players.reduce((sum, p) => sum + p.reputation, 0);
        const avgReputation = totalReputation / players.length;
        if (pondHealth > 80 && avgReputation > 0.5) {
             addSuggestion({
                cardId: 'vandorkereskedo', cardType: 'chaos',
                name: 'V√°ndorkeresked≈ë',
                justification: `A t√≥ eg√©szs√©ges (${pondHealth}%), a k√∂z√∂ss√©g pedig egy√ºttm≈±k√∂d≈ë (√°tlag h√≠rn√©v: ${avgReputation.toFixed(1)}).`,
                narrative: `A j√≥ h√≠r≈±, vir√°gz√≥ k√∂z√∂ss√©gbe egy v√°ndorkeresked≈ë √©rkezik, aki egyedi lehet≈ës√©get k√≠n√°l a hal√°szoknak a k√∂z√∂s gyarapod√°sra.`
            });
        }
        
        return suggestions;
    }

    function updateAdvisorPanel() {
        dom.eventAdvisorPanel.innerHTML = '';
        const suggestions = getAdvisorSuggestions();
        let content = `<h3 class="text-sm font-semibold mb-2" style="color:var(--muted)">Esem√©nytan√°csad√≥</h3>`;
        if (suggestions.length === 0) {
            content += `<p class="text-xs text-center p-2 rounded-lg" style="color:var(--muted); background: rgba(20,35,60,0.05);">A helyzet stabil, nincsenek kiemelt javaslatok.</p>`;
        } else {
            content += `<div class="space-y-3">`;
            suggestions.forEach(s => {
                const isWarning = s.type === 'warning';
                const borderColor = isWarning ? 'var(--c-gold)' : 'var(--c-turq)';
                const buttonHTML = isWarning ? '' : `<button class="prepare-event-btn w-full text-xs font-semibold py-1.5 px-2 rounded-lg mt-3" 
                        style="background:var(--c-cream); color:#283142;"
                        data-card-id="${s.cardId}" data-card-type="${s.cardType}">El≈ëk√©sz√≠t√©s</button>`;
                
                content += `
                <div class="advisor-card p-3 rounded-xl card-glass border-l-4" style="border-color: ${borderColor};">
                    <h4 class="font-bold text-sm leading-tight">${s.name}</h4>
                    <p class="text-xs mt-1" style="color:var(--muted)"><strong>Indokl√°s:</strong> ${s.justification}</p>
                    <blockquote class="text-xs mt-2">${s.narrative}</blockquote>
                    ${buttonHTML}
                </div>`;
            });
            content += `</div>`;
        }
        dom.eventAdvisorPanel.innerHTML = content;
    }
    
    function renderActiveEffectsPanel() {
        const allEffects = [...gameState.effectHistory].sort((a,b) => b.roundTriggered - b.roundTriggered);

        if (allEffects.length === 0 && !gameState.pollutedWater.enabled) {
            dom.activeEffectsSection.classList.add('hidden');
            return;
        }
        dom.activeEffectsSection.classList.remove('hidden');
        dom.activeEffectsPanel.innerHTML = '';

        const groups = {
            pending: [],
            active: [],
            expired: []
        };

        const pollutionEffect = gameState.pollutedWater.enabled ? {
            id: 'szennyezett_viz_armed',
            name: 'Szennyezett V√≠z Rendszer',
            icon: 'üíß',
            color: annotationColors.globalBad,
            status: 'active',
            statusText: '',
            description: '',
            targets: 'Mindenki'
        } : null;

        if (pollutionEffect) {
            const pw = gameState.pollutedWater;
            if (pw.activeFromRound !== null) {
                pollutionEffect.statusText = `AKT√çV (Regen: ${pw.multiplier.toFixed(1)}x)`;
                pollutionEffect.description = 'A t√≥ regener√°ci√≥ja cs√∂kkent.';
            } else if (pw.armedAtRound !== null) {
                pollutionEffect.statusText = '√âLES√çTVE (T√∫lhal√°szat sz√°ml√°l√≥)';
                pollutionEffect.description = `${GAME_CONFIG.POLLUTED_WATER.START_DELAY - (gameState.round - pw.armedAtRound)} nap a cs√∂kkent√©sig.`;
            } else {
                pollutionEffect.statusText = 'Enged√©lyezve';
                pollutionEffect.description = 'A tart√≥s t√∫lhal√°szat cs√∂kkentheti a regener√°ci√≥t.';
            }
            groups.active.push(pollutionEffect);
        }

        allEffects.forEach(effect => {
            if (effect.id === 'szennyezett_viz_armed') return;

            const start = effect.roundTriggered + (effect.startOffset || 0);
            const end = start + (effect.duration || 1) - 1;
            
            let status = 'expired';
            let statusText = '';
            let icon = effect.icon || effectIcons.neutral;
            const daysAgo = gameState.round - effect.roundTriggered;

            if (gameState.round < start) {
                status = 'pending';
                const remaining = start - gameState.round;
                statusText = `(Akt√≠v ${remaining} nap m√∫lva)`;
                icon = effectIcons.pending;
            } else if (gameState.round >= start && gameState.round <= end && effect.type === 'duration') {
                status = 'active';
                const remaining = end - gameState.round + 1;
                statusText = `(${remaining} nap van h√°tra)`;
            } else {
                statusText = daysAgo === 0 ? `(Ezen a napon)` : `(${daysAgo} nappal ezel≈ëtt)`;
            }
            
            const targets = (effect.targets && effect.targets.length > 0) ? (effect.targets.includes('global') ? 'Mindenki' : effect.targets.map(id => gameState.players.find(p=>p.id===id)?.name).join(', ')) : '';
            const outcomeHTML = status === 'expired' && effect.outcome ? `<p class="outcome">Eredm√©ny: ${effect.outcome}</p>` : '';
            const detailsHTML = (effect.details && effect.details.length > 0) ? `<div class="details"><strong>R√©szletek:</strong><ul class="list-disc list-inside ml-1">${effect.details.map(d => `<li>${d}</li>`).join('')}</ul></div>` : '';
            
            const cardData = {
                id: effect.id,
                name: effect.name,
                icon,
                color: effect.color,
                status,
                statusText,
                description: effect.description || '',
                targets,
                outcomeHTML,
                detailsHTML
            };
            
            groups[status].push(cardData);
        });

        const renderGroup = (title, group, isOpen = false) => {
            if (group.length === 0) return '';
            
            const cardsHTML = group.map(c => `
                <div class="effect-card status-${c.status}" style="border-left-color: ${c.color};">
                    <div class="icon">${c.icon}</div>
                    <div class="content">
                        <h4>${c.name} <span>${c.statusText}</span></h4>
                        ${c.description ? `<p class="desc">${c.description}</p>` : ''}
                        ${c.targets ? `<p class="targets">√ârintett: ${c.targets}</p>`: ''}
                        ${c.outcomeHTML}
                        ${c.detailsHTML}
                    </div>
                </div>
            `).join('<div class="h-2"></div>');

            return `
                <details ${isOpen ? 'open' : ''}>
                    <summary>${title} (${group.length})</summary>
                    <div class="effects-group-content">${cardsHTML}</div>
                </details>
            `;
        };
        
        dom.activeEffectsPanel.innerHTML = `
            ${renderGroup('F√ºgg≈ëben l√©v≈ë esem√©nyek', groups.pending)}
            ${renderGroup('Akt√≠v esem√©nyek', groups.active, true)}
            ${renderGroup('Lez√°rult esem√©nyek', groups.expired)}
        `;
    }

    function populateAuditLogFilter() {
        dom.auditLogPlayerFilter.innerHTML = '<option value="all">Mindenki</option>';
        gameState.players.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = p.name;
            dom.auditLogPlayerFilter.appendChild(opt);
        });
    }

    function renderAuditLog() {
        populateAuditLogFilter();
        const filter = dom.auditLogPlayerFilter.value;
        const groupingMode = document.querySelector('input[name="audit-grouping"]:checked').value;
        const logData = gameState.auditLog || [];
        const filteredData = filter === 'all' ? logData : logData.filter(e => e.playerId == filter);
        
        if (filteredData.length === 0) {
            dom.auditLogTableContainer.innerHTML = '<p class="text-center p-8" style="color:var(--muted)">Nincsenek megjelen√≠thet≈ë adatok.</p>';
            return;
        }

        let tableHTML = `<table class="w-full audit-table">
            <thead class="table-head sticky top-0"><tr>
                <th>${groupingMode === 'by-day' ? 'Nap' : 'Hal√°sz'}</th>
                <th>${groupingMode === 'by-day' ? 'Hal√°sz' : 'Nap'}</th>
                <th>Vagyon (Start)</th><th>Fog√°s / Fennt. R√©szar√°ny</th><th>Bev√©tel</th>
                <th>K√∂lts√©gek</th><th>M√≥dos√≠t√≥k</th><th>H√≠rn√©v +/-</th><th>Vagyon (V√©g)</th><th>Sz√°m√≠t√°s</th>
            </tr></thead><tbody>`;

        if (groupingMode === 'by-day') {
            let currentRound = -1;
            filteredData.sort((a,b) => a.round - b.round || a.playerId - b.playerId).forEach(entry => {
                if (filter === 'all' && entry.round !== currentRound) {
                    currentRound = entry.round;
                    const overfishing = entry.roundData.totalCatch - entry.roundData.mff;
                    tableHTML += `<tr class="round-summary-row"><td colspan="10">
                        ${getFullDay(currentRound)} | T√≥: ${Math.floor(entry.roundData.pondStart)} | √ñssz. fog√°s: ${entry.roundData.totalCatch} / MFF: ${Math.floor(entry.roundData.mff)} (T√∫lhal√°szat: ${Math.floor(overfishing)})
                    </td></tr>`;
                }
                tableHTML += renderAuditLogRow(entry, 'by-day');
            });
        } else {
            const groupedByPlayer = filteredData.reduce((acc, entry) => {
                if (!acc[entry.playerId]) acc[entry.playerId] = { name: entry.playerName, entries: [] };
                acc[entry.playerId].entries.push(entry);
                return acc;
            }, {});
            
            Object.values(groupedByPlayer).sort((a,b) => a.name.localeCompare(b.name)).forEach(playerData => {
                if(filter === 'all') {
                    tableHTML += `<tr class="player-summary-row"><td colspan="10">${playerData.name}</td></tr>`;
                }
                playerData.entries.sort((a,b) => a.round - b.round).forEach(entry => {
                    tableHTML += renderAuditLogRow(entry, 'by-player');
                });
            });
        }

        tableHTML += '</tbody></table>';
        dom.auditLogTableContainer.innerHTML = tableHTML;
    }

    function renderAuditLogRow(entry, mode) {
        const catchColor = entry.catch.actual > entry.fairShare ? 'var(--c-red)' : '#227a66';
        const repChangeText = entry.reputationChange > 0 ? `+${entry.reputationChange}` : entry.reputationChange;
        const repColor = entry.reputationChange < 0 ? 'var(--c-red)' : (entry.reputationChange > 0 ? '#227a66' : 'var(--muted)');
        const dayDisplay = `${getFullDay(entry.round)} <span class="log-link cursor-pointer" data-round="${entry.round}">üìú</span>`;
        const adj = entry.adjustments;
        const adjText = adj.total === 0 ? '0' : (adj.total > 0 ? `+${adj.total}` : adj.total);
        
        const start = entry.wealthStart;
        const income = entry.income.total;
        const cost = entry.costs.total;
        const adjTotal = adj.total;
        const end = entry.wealthEnd;
        const equation = `${start} ${income >= 0 ? '+' : ''} ${income} ${cost > 0 ? '-' : ''} ${cost} ${adjTotal > 0 ? '+' : ''} ${adjTotal !== 0 ? adjTotal : ''} = ${end}`;

        return `<tr>
            <td>${mode === 'by-day' ? dayDisplay : entry.playerName}</td>
            <td>${mode === 'by-day' ? entry.playerName : dayDisplay}</td>
            <td>${entry.wealthStart}</td>
            <td style="color:${catchColor}; font-weight: bold;">${entry.catch.actual} / ${entry.fairShare}</td>
            <td title="${entry.income.details}">${entry.income.total}</td>
            <td title="${entry.costs.details}">${-entry.costs.total}</td>
            <td title="${adj.details}">${adjText}</td>
            <td style="color:${repColor}">${repChangeText}</td>
            <td class="font-bold">${entry.wealthEnd}</td>
            <td class="font-mono text-xs">${equation}</td>
        </tr>`;
    }

    function updateCharts(s){
      const rounds = Array.from({length:s.round},(_,i)=> getFullDay(i));
      const totalWealth = Math.floor(s.players.reduce((sum,p)=>sum+p.fish,0));
      animateNumber(dom.totalWealthNumber, totalWealth);
      playerWealthChart.data.labels = s.players.map(p=>p.name); playerWealthChart.data.datasets[0].data = s.players.map(p=>p.fish);
      playerWealthChart.data.datasets[0].backgroundColor = s.players.map((p,i)=>p.isBankrupt?'#9ca3af':playerColors[i%playerColors.length]);
      playerWealthChart.update('none');
      const annotations = {}; const yOffsets = {};
      const sortedAnnotations = [...(s.annotations || [])].sort((a,b) => a.startRound - b.startRound);
      sortedAnnotations.forEach((anno, i) => {
        if(s.round < anno.startRound) return; 
        let yAdjust = yOffsets[anno.startRound] || 0;
        annotations[`box${i}`] = { type: 'box', xMin: anno.startRound - 1, xMax: anno.endRound, backgroundColor: anno.color, borderColor: 'transparent', label: { content: anno.label, display: true, position: 'end', color: isDark() ? '#fff' : '#000', font: { size: 11 }, yAdjust: yAdjust } };
        yOffsets[anno.startRound] = yAdjust - 14;
      });
      pondHistoryChart.options.plugins.annotation.annotations = annotations;
      pondHistoryChart.data.labels = rounds; pondHistoryChart.data.datasets[0].data = s.history.pond.slice(0,s.round).map(x=>Math.floor(x));
      pondHistoryChart.options.scales.y.max = s.maxPond; pondHistoryChart.update('none');
      playerWealthHistoryChart.data.labels = rounds;
      playerWealthHistoryChart.data.datasets = s.players.map((p,i)=>({ label:p.name, data:p.history.wealth.slice(0,s.round), borderColor: playerColors[i%playerColors.length], tension:0.15, hidden:p.isBankrupt, backgroundColor: playerColors[i%playerColors.length] }));
      playerWealthHistoryChart.update('none');
      catchHistoryChart.data.labels = rounds.slice(1,s.round);
      catchHistoryChart.data.datasets = s.players.map((p,i)=>({ label:p.name, data:p.history.catch.slice(1,s.round), backgroundColor: playerColors[i%playerColors.length], borderColor: playerColors[i%playerColors.length] }));
      catchHistoryChart.update('none');
    }
    
    function updateFixedCost(v){ const n=parseInt(v); if(!isNaN(n)&&n>=0){ gameState.fixedCost=n; dom.fixedCostDisplay.textContent=n; logEvent(`A fix k√∂lts√©g manu√°lisan ${n}-ra lett √°ll√≠tva.`); } }
    function resetGame(){ if(confirm('Biztosan √∫j j√°t√©kot szeretne ind√≠tani? Minden jelenlegi adat elv√©sz.')) { dom.gameScreen.classList.add('hidden'); dom.setupScreen.classList.remove('hidden'); dom.playerCountInput.value = 4; dom.pondStatusDisplay.textContent = '100'; dom.bankStatusDisplay.textContent = '0'; dom.fixedCostDisplay.textContent = '0'; dom.sustainableCatchDisplay.textContent = '0'; dom.maxGrowthCatchDisplay.textContent = '0'; dom.sustainabilityTableBody.innerHTML = ''; dom.totalWealthNumber.textContent = '0'; dom.playerInputsContainer.innerHTML = ''; [playerWealthChart, pondHistoryChart, playerWealthHistoryChart, catchHistoryChart].forEach(ch=>{ try{ ch?.destroy(); }catch(e){} }); gameState = {}; undoStack = []; updateUndoButton(); renderLog(); } }
    const STORAGE_KEY = 'pdfSections_v2';
    function loadPdfSectionPrefs(){ const raw = localStorage.getItem(STORAGE_KEY); const inputs = document.querySelectorAll('input[name="pdf-sections"]'); if(!raw) return; try{ const arr=JSON.parse(raw); const set=new Set(arr); inputs.forEach(i=> i.checked=set.has(i.value)); }catch(e){} }
    function savePdfSectionPrefs(){ const picks = Array.from(document.querySelectorAll('input[name="pdf-sections"]:checked')).map(i=>i.value); localStorage.setItem(STORAGE_KEY, JSON.stringify(picks)); }
    document.addEventListener('change', e=>{ if(e.target && e.target.matches('input[name="pdf-sections"]')) savePdfSectionPrefs(); });
    
    async function exportToPDF(){
        if (isExporting) return; isExporting = true;
        dom.exportPdfBtn.classList.add('btn-disabled'); const oldText = dom.exportPdfBtn.textContent; dom.exportPdfBtn.textContent = 'Export√°l√°s...';
        const currentThemeDark = document.documentElement.classList.contains('dark');
        if(currentThemeDark) { document.documentElement.classList.remove('dark'); applyChartTheme(); }

        const originalHiddenStates = [];
        if (playerWealthHistoryChart) {
            playerWealthHistoryChart.data.datasets.forEach((dataset, index) => {
                originalHiddenStates[index] = dataset.hidden;
                dataset.hidden = false;
            });
            playerWealthHistoryChart.update('none');
        }

        [playerWealthChart, pondHistoryChart, playerWealthHistoryChart, catchHistoryChart].filter(Boolean).forEach(ch=>{ try{ ch.resize(); ch.update('none'); }catch(e){} });
        await new Promise(r=>setTimeout(r,50));
        
        const isLogExport = document.querySelector('input[name="pdf-sections"][value="#log-panel"]')?.checked; let tempLogPanel = null;
        if (isLogExport) { tempLogPanel = document.createElement('div'); tempLogPanel.id = "log-panel-printable"; tempLogPanel.className = 'p-4 bg-white'; tempLogPanel.innerHTML = `<h3 class="text-lg font-bold mb-4">J√°t√©knapl√≥</h3>` + document.getElementById('log-content').innerHTML; document.body.appendChild(tempLogPanel); }
        
        const isAuditExport = document.querySelector('input[name="pdf-sections"][value="#audit-log-modal-content"]')?.checked;
        if (isAuditExport) { dom.auditLogModalContent.style.transform = 'none'; dom.auditLogModalContent.style.transition = 'none'; dom.auditLogTableContainer.style.maxHeight = 'none'; }
        
        const sustainScroll = document.querySelector('#sustainability-container .sustainability-table-container'); const oldMaxH = sustainScroll ? sustainScroll.style.maxHeight : null; const oldOverflow = sustainScroll ? sustainScroll.style.overflowY : null;
        if (sustainScroll) { sustainScroll.style.maxHeight='none'; sustainScroll.style.overflowY='visible'; }
        
        // Az Elemz≈ë T√©r kinyit√°sa a PDF exporthoz
        const analysisBay = document.getElementById('analysis-bay-details');
        const wasAnalysisBayOpen = analysisBay.open;
        if (!wasAnalysisBayOpen) analysisBay.open = true;
        await new Promise(r=>setTimeout(r,50));

        const blocks = getBlocksToExport(); const canvases = [];
        for (const el of blocks) { const c = await html2canvas(el, { backgroundColor:'#ffffff', scale: 2 }); canvases.push(c); }
        
        const pdf = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });
        const margin = 30; const pageW = pdf.internal.pageSize.getWidth();
        const contentW = pageW - margin * 2;
        
        for (let i = 0; i < canvases.length; i++) {
            if (i > 0) pdf.addPage();
            const canvas = canvases[i];
            const canvasAspect = canvas.width / canvas.height;
            const scaledH = contentW / canvasAspect;
            pdf.addImage(canvas.toDataURL('image/png'), 'PNG', margin, margin, contentW, scaledH);
        }

        if (sustainScroll) { sustainScroll.style.maxHeight = oldMaxH ?? ''; sustainScroll.style.overflowY = oldOverflow ?? ''; }
        if (isAuditExport) { dom.auditLogModalContent.style.transform = ''; dom.auditLogModalContent.style.transition = ''; dom.auditLogTableContainer.style.maxHeight = ''; }
        if (tempLogPanel) document.body.removeChild(tempLogPanel);
        if (!wasAnalysisBayOpen) analysisBay.open = false;
        
        if (playerWealthHistoryChart) {
            playerWealthHistoryChart.data.datasets.forEach((dataset, index) => {
                dataset.hidden = originalHiddenStates[index];
            });
            playerWealthHistoryChart.update('none');
        }
        
        if(currentThemeDark) { document.documentElement.classList.add('dark'); applyChartTheme(); }
        [playerWealthChart, pondHistoryChart, playerWealthHistoryChart, catchHistoryChart].filter(Boolean).forEach(ch=>{ try{ ch.resize(); ch.update('none'); }catch(e){} });
        
        const ts = new Date(); const fname = `Halasto_Riport_${ts.getFullYear()}-${String(ts.getMonth()+1).padStart(2,'0')}-${String(ts.getDate()).padStart(2,'0')}.pdf`;
        pdf.save(fname);
        dom.exportPdfBtn.innerHTML = oldText;
        dom.exportPdfBtn.classList.remove('btn-disabled'); setTimeout(()=>{ isExporting = false; }, 100);
    }
    function getBlocksToExport(){ const picks = Array.from(document.querySelectorAll('input[name="pdf-sections"]:checked')).map(i=>i.value); const defaultSelectors = ['#chart1-container','#sustainability-container','#chart3-container','#chart4-container']; const selectors = (picks.length ? picks : defaultSelectors); const list=[]; selectors.forEach(sel=>{ let el = document.querySelector(sel); if (sel === '#log-panel' && document.querySelector('#log-panel-printable')) el = document.querySelector('#log-panel-printable'); if(el) list.push(el); }); return list; }
    const logToggleBtn = document.getElementById('log-toggle-btn'), logPanel = document.getElementById('log-panel'), logCloseBtn = document.getElementById('log-close-btn'), logContent = document.getElementById('log-content');
    function logEvent(text, options = {}) { if (!gameState.log) gameState.log = []; const timestamp = new Date().toLocaleTimeString('hu-HU', { hour: '2-digit', minute: '2-digit' }); gameState.log.push({ text, timestamp, flagged: false, notes: '', isDetail: options.isDetail || false }); renderLog(); }
    function renderLog() { if (!logContent) return; const logHtml = (gameState.log || []).map((entry, index) => `<div class="log-entry text-sm p-2 rounded-lg ${entry.flagged ? 'border-l-4 border-amber-400' : ''} ${entry.isDetail ? 'log-entry-detail':''}" style="background: rgba(20,35,60,0.05);" data-log-round="${Math.ceil((index+1)/gameState.players.length)}"><div class="flex justify-between items-start"><div><span class="font-mono text-xs opacity-60">${entry.timestamp}</span><p class="leading-tight">${entry.text}</p></div><button class="log-flag-btn p-1 opacity-50 hover:opacity-100 ${entry.flagged ? 'opacity-100' : ''}" data-index="${index}" title="Fontos esem√©ny megjel√∂l√©se"><svg class="w-4 h-4" fill="${entry.flagged ? 'var(--c-gold)' : 'currentColor'}" viewBox="0 0 20 20"><path d="M3 3a1 1 0 00-1 1v12a1 1 0 001 1h1a1 1 0 001-1V4a1 1 0 00-1-1H3zm3.707 1.293a1 1 0 00-1.414 0l-2 2a1 1 0 000 1.414l2 2a1 1 0 001.414-1.414L5.414 7H16a1 1 0 100-2H5.414l1.293-1.293a1 1 0 000-1.414z"></path></svg></button></div>${entry.flagged ? `<textarea class="log-entry-note w-full mt-2 p-1.5 rounded" data-index="${index}" placeholder="Jegyzet...">${entry.notes}</textarea>` : ''}</div>`).reverse().join(''); logContent.innerHTML = logHtml || '<p class="text-xs text-center p-4" style="color:var(--muted)">A napl√≥ √ºres.</p>'; logContent.scrollTop = 0; }
    logToggleBtn.addEventListener('click', () => logPanel.classList.toggle('open')); logCloseBtn.addEventListener('click', () => logPanel.classList.remove('open'));
    logContent.addEventListener('click', (e) => { const btn = e.target.closest('.log-flag-btn'); if (btn) { const index = parseInt(btn.dataset.index); gameState.log[index].flagged = !gameState.log[index].flagged; renderLog(); } });
    logContent.addEventListener('input', (e) => { const textarea = e.target.closest('.log-entry-note'); if (textarea) { const index = parseInt(textarea.dataset.index); gameState.log[index].notes = textarea.value; } });
    const timerDisplay = document.getElementById('timer-display'), timerSelect = document.getElementById('timer-select'), timerMute = document.getElementById('timer-mute'), timerStartBtn = document.getElementById('timer-start-btn'), timerResetBtn = document.getElementById('timer-reset-btn'); let timerInterval = null, timeLeft = parseInt(timerSelect.value); const timerSound = new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU'+Array(300).join('123'));
    function updateTimerDisplay() { const minutes = String(Math.floor(timeLeft / 60)).padStart(2, '0'); const seconds = String(timeLeft % 60).padStart(2, '0'); timerDisplay.textContent = `${minutes}:${seconds}`; }
    function startTimer() { if (timerInterval) return; timerStartBtn.textContent = "Sz√ºnet"; timerInterval = setInterval(() => { timeLeft--; updateTimerDisplay(); if (timeLeft <= 0) { clearInterval(timerInterval); timerInterval = null; if (!timerMute.checked) timerSound.play(); alert("Lej√°rt az id≈ë!"); timerStartBtn.textContent = "Start"; } }, 1000); }
    function pauseTimer() { clearInterval(timerInterval); timerInterval = null; timerStartBtn.textContent = "Start"; } function resetTimer() { pauseTimer(); timeLeft = parseInt(timerSelect.value); updateTimerDisplay(); }
    timerStartBtn.addEventListener('click', () => timerInterval ? pauseTimer() : startTimer()); timerResetBtn.addEventListener('click', resetTimer); timerSelect.addEventListener('change', resetTimer);
    document.addEventListener('DOMContentLoaded', () => {
      const key='theme', root = document.documentElement, saved = localStorage.getItem(key);
      if(saved ? saved==='dark' : window.matchMedia('(prefers-color-scheme: dark)').matches) root.classList.add('dark');
      const btn = document.getElementById('theme-toggle'), icon = document.getElementById('theme-icon');
      function setIcon(){ icon.innerHTML = root.classList.contains('dark') ? '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79Z"/>' : '<path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12Z M12 2v2M12 20v2M4 12H2M22 12h-2M5 5l-1.5-1.5M20.5 20.5 19 19M19 5l1.5-1.5M5 19 3.5 20.5"/>'; }
      setIcon(); btn?.addEventListener('click', ()=>{ root.classList.toggle('dark'); localStorage.setItem(key, root.classList.contains('dark')?'dark':'light'); setIcon(); applyChartTheme(); [playerWealthChart, pondHistoryChart, playerWealthHistoryChart, catchHistoryChart].forEach(ch=>ch?.update('none')); });
      
      // F≈ë esem√©nykezel≈ëk
      dom.startGameBtn.addEventListener('click', initGame); dom.endGameBtn.addEventListener('click', endRound); dom.newGameBtn.addEventListener('click', resetGame); dom.undoBtn.addEventListener('click', undoLastRound); dom.exportPdfBtn.addEventListener('click', exportToPDF, { passive:true });
      dom.demoFillBtn.addEventListener('click', ()=>{ if (dom.gameScreen.classList.contains('hidden')) initGame(); for(let k=0;k<6;k++){ gameState.players.forEach(p=>{ if(!p.isBankrupt) { const max = Math.max(0, Math.floor(gameState.pond / gameState.players.length * 0.8)); const val = Math.max(0, Math.min(8, Math.floor(Math.random() * (max+1)))); const inp = document.getElementById(`player-${p.id}-catch`); if (inp && !inp.disabled) inp.value = val; } }); endRound(); } });
      
      // Fix k√∂lts√©g szerkeszt√©se
      dom.fixedCostCard.addEventListener('click', ()=>{ const curr = gameState.fixedCost ?? 0; dom.fixedCostDisplayContainer.innerHTML = `<input type="number" id="inline-fixed-cost-edit" value="${curr}" class="font-black number-display w-full text-center rounded-xl border p-1" style="color:var(--text); background: rgba(225,234,204,.5); border-color: var(--c-turq);">`; const input = document.getElementById('inline-fixed-cost-edit'); input.focus(); input.select(); const save = ()=>{ updateFixedCost(input.value); dom.fixedCostDisplayContainer.innerHTML = `<p id="fixed-cost-display" class="font-black number-display mt-1" style="color:var(--text)">${gameState.fixedCost}</p>`; }; input.addEventListener('blur', save); input.addEventListener('keydown', e=>{ if(e.key==='Enter') input.blur(); }); });
      
      // N√©v √©s Vagyon esem√©nykezel≈ëk
      dom.playerInputsContainer.addEventListener('click', e => {
        const span = e.target.closest('.player-name-span');
        const icon = e.target.closest('.player-rep-icon');
        
        if (icon) {
            showPlayerWealth(parseInt(icon.dataset.playerId));
            return;
        }
        if (!span) return;
        const player = gameState.players.find(p => p.id == span.dataset.playerId);
        if(!player) return;
        const input = document.createElement('input'); input.type = 'text'; input.value = player.name; input.className = 'w-full text-sm font-medium p-1 rounded'; span.replaceWith(input); input.focus(); input.select();
        const saveName = () => { const newName = input.value.trim(); if(newName) player.name = newName; const newSpan = document.createElement('span'); newSpan.className = span.className; newSpan.dataset.playerId = span.dataset.playerId; newSpan.style.cssText = span.style.cssText; newSpan.textContent = player.name; input.replaceWith(newSpan); updateAllUI(); };
        input.addEventListener('blur', saveName);
        input.addEventListener('keydown', e => { if (e.key === 'Enter') input.blur(); });
      });

      // TAB F√ìKUSZ CSAPDA
      dom.playerInputsContainer.addEventListener('keydown', (e) => {
        if (e.key !== 'Tab') return;
        const inputs = Array.from(dom.playerInputsContainer.querySelectorAll('.player-catch-input:not(:disabled)'));
        if (inputs.length <= 1) return;
        
        const currentIndex = inputs.indexOf(e.target);
        
        if (e.shiftKey && currentIndex === 0) {
            e.preventDefault();
            inputs[inputs.length - 1].focus();
        } else if (!e.shiftKey && currentIndex === inputs.length - 1) {
            e.preventDefault();
            inputs[0].focus();
        }
      });
      
      // Esem√©nyind√≠t√≥k
      dom.triggerChaosBtn.addEventListener('click', ()=>{ const card = chaosCards.find(c=>c.id===dom.chaosCardSelect.value); if(card && card.setupModal){ triggerFlash(); card.setupModal(); } dom.chaosCardSelect.value='none'; });
      dom.triggerMarketBtn.addEventListener('click', ()=>{
        let id = dom.marketCardSelect.value; if(id==='random'){ const pool = marketCards.filter(c=>c.id!=='none' && c.id!=='random'); id = pool[Math.floor(Math.random()*pool.length)].id; }
        const card = marketCards.find(c=>c.id===id);
        if(!card || card.id === 'none') return;
        triggerFlash();
        if (card.hasDuration) {
            const body = `<p class="mb-2"><strong>${card.name}</strong>: ${card.description}</p><div class="grid grid-cols-2 gap-4 mt-4">${createDurationSelectorHTML()}${createStartDelaySelectorHTML()}</div>`;
            const buttons = [modalCancelButton, { text: 'Aktiv√°l√°s', classes: 'px-4 py-2 rounded-xl btn-primary', handler: () => {
                const d = getDurationFromSelector(); const o = getStartDelayFromSelector(); triggerEffect({ id: card.id, name: card.name, type:'duration', duration: d, startOffset: o, description: card.description, targets: ['global'], color: card.color, icon: card.icon });
                hideModal('chaos-modal'); updateAllUI();
            }}];
            createModalElements('Piaci Esem√©ny Id≈ëtartama', body, buttons, card.color === annotationColors.globalGood ? 'good' : 'bad');
        } else if (card.isInstant) {
            let outcome = card.description;
            if(id === 'swarm'){ gameState.pond = Math.min(gameState.maxPond, gameState.pond + 50); outcome = "+50 hal a t√≥ba"; }
            triggerEffect({ id: card.id, name: card.name, type: 'instant', outcome: outcome, targets: ['global'], color: card.color, icon: card.icon });
            updateAllUI();
        }
        dom.marketCardSelect.value='none';
      });
      
      // === v8.10 Isteni Beavatkoz√°s (M√ìDOS√çTOTT √©s √öJ) ===
      document.getElementById('divine-fish-btn').addEventListener('click', () => { const amount = parseInt(document.getElementById('divine-fish-amount').value); if (!isNaN(amount)) { gameState.pond += amount; logEvent(`Isteni Beavatkoz√°s: ${amount > 0 ? '+' : ''}${amount} hal a t√≥hoz adva.`); updateAllUI(); document.getElementById('divine-fish-amount').value = ''; } });
      document.getElementById('divine-regen-btn').addEventListener('click', () => { const modifier = parseFloat(document.getElementById('divine-regen-modifier').value); const duration = parseInt(document.getElementById('divine-regen-duration').value); if (!isNaN(modifier) && !isNaN(duration) && duration > 0) { triggerEffect({ id: 'divine_regen', name: `Szaporulat M√≥dos√≠t√≥ (${modifier}x)`, type: 'duration', duration, description: `Regener√°ci√≥s r√°ta m√≥dos√≠tva: ${modifier}x`, targets: ['global'], color: annotationColors.globalGood, icon: 'üìà', modifier }); document.getElementById('divine-regen-modifier').value = ''; document.getElementById('divine-regen-duration').value = ''; } });

      // √öJ (v8.10): J√°t√©kos Vagyona +/-
      document.getElementById('divine-player-fish-btn').addEventListener('click', () => {
          const amount = parseInt(document.getElementById('divine-player-fish-amount').value);
          if (isNaN(amount)) return;
          const targets = getDivineTargets();
          if (targets.length === 0) { alert('Nincs kiv√°lasztva c√©lpont j√°t√©kos.'); return; }

          targets.forEach(playerId => {
              addPlayerAdjustment(playerId, amount, `Isteni Beavatkoz√°s (Vagyon)`);
              const player = gameState.players.find(p => p.id === playerId);
              logEvent(`Isteni Beavatkoz√°s: ${player.name} vagyona m√≥dos√≠tva (${amount > 0 ? '+' : ''}${amount}).`);
          });
          
          updateAllUI();
          document.getElementById('divine-player-fish-amount').value = '';
      });

      // M√ìDOS√çTOTT (v8.10): C√©lzott Ad√≥
      document.getElementById('divine-tax-btn').addEventListener('click', () => {
          const modifier = parseInt(document.getElementById('divine-tax-modifier').value);
          const duration = parseInt(document.getElementById('divine-tax-duration').value);
          if (isNaN(modifier) || isNaN(duration) || duration <= 0) return;
          
          const targets = getDivineTargets();
          if (targets.length === 0) { alert('Nincs kiv√°lasztva c√©lpont j√°t√©kos.'); return; }
          
          const targetNames = [];
          targets.forEach(playerId => {
              const player = gameState.players.find(p => p.id === playerId);
              if (player) {
                  triggerEffect({ 
                      id: `divine_tax_${player.id}`, 
                      name: `Ad√≥m√≥dos√≠t√≥ (${modifier > 0 ? '+' : ''}${modifier})`, 
                      type: 'duration', 
                      duration, 
                      description: `Fix k√∂lts√©g m√≥dos√≠tva: ${modifier}`, 
                      targets: [player.id], // C√©lzott
                      color: annotationColors.playerNeutral, 
                      icon: 'üìú', 
                      modifier,
                      annoLabel: `Ad√≥ (${player.name})`
                  });
                  targetNames.push(player.name);
              }
          });
          
          logEvent(`Isteni Beavatkoz√°s (Ad√≥: ${modifier > 0 ? '+' : ''}${modifier}, ${duration} nap): ${targetNames.join(', ')}.`);
          document.getElementById('divine-tax-modifier').value = ''; 
          document.getElementById('divine-tax-duration').value = '';
      });

      // M√ìDOS√çTOTT (v8.10): C√©lzott Rakt√°rt≈±z
      document.getElementById('divine-fire-btn').addEventListener('click', () => {
          const percent = parseInt(document.getElementById('divine-fire-percent').value);
          if (isNaN(percent) || percent <= 0 || percent > 100) return;
          
          const targets = getDivineTargets();
          if (targets.length === 0) { alert('Nincs kiv√°lasztva c√©lpont j√°t√©kos.'); return; }
          
          if (confirm(`Biztosan cs√∂kkenti a kiv√°lasztott j√°t√©kos(ok) vagyon√°t ${percent}%-kal?`)) {
              let totalLoss = 0;
              const targetNames = [];
              targets.forEach(playerId => {
                  const player = gameState.players.find(p => p.id === playerId);
                  if (player && !player.isBankrupt) {
                      const loss = Math.ceil(player.fish * (percent / 100));
                      if (loss > 0) {
                          addPlayerAdjustment(player.id, -loss, 'Rakt√°rt≈±z (c√©lzott)');
                          totalLoss += loss;
                          targetNames.push(`${player.name} (-${loss})`);
                      }
                  }
              });
              
              logEvent(`Isteni Beavatkoz√°s (Rakt√°rt≈±z ${percent}%): ${targetNames.join(', ')}. √ñsszesen ${totalLoss} hal elveszett.`);
              updateAllUI();
              document.getElementById('divine-fire-percent').value = '';
          }
      });
      // === v8.10 V√âGE ===

      
      // Esem√©nytan√°csad√≥
      dom.eventAdvisorPanel.addEventListener('click', (e) => {
        const button = e.target.closest('.prepare-event-btn');
        if (!button) return;
        const cardId = button.dataset.cardId;
        const cardType = button.dataset.cardType;
        let targetSelect;
        if (cardType === 'market') targetSelect = dom.marketCardSelect;
        else if (cardType === 'chaos') targetSelect = dom.chaosCardSelect;
        
        if (targetSelect) {
            targetSelect.value = cardId;
            targetSelect.scrollIntoView({ behavior: 'smooth', block: 'center' });
            targetSelect.parentElement.style.transition = 'background-color 0.2s ease-out';
            targetSelect.parentElement.style.backgroundColor = 'var(--c-gold)';
            setTimeout(() => { targetSelect.parentElement.style.backgroundColor = ''; }, 600);
        }
      });
      
      // Mod√°lis ablakok bez√°r√°sa
      dom.auditLogCloseBtn.addEventListener('click', () => hideModal('audit-log-modal'));
      dom.playerWealthCloseBtn.addEventListener('click', () => hideModal('player-wealth-modal'));
      dom.showAuditLogBtn.addEventListener('click', () => { renderAuditLog(); showModal('audit-log-modal'); });
      
      // Audit napl√≥ sz≈±r≈ëk
      dom.auditLogPlayerFilter.addEventListener('change', renderAuditLog);
      document.querySelectorAll('input[name="audit-grouping"]').forEach(radio => radio.addEventListener('change', renderAuditLog));
      dom.auditLogTableContainer.addEventListener('click', (e) => {
          const link = e.target.closest('.log-link');
          if (link) {
              const round = link.dataset.round;
              logPanel.classList.add('open');
              setTimeout(() => {
                  const logEntries = Array.from(logContent.querySelectorAll('.log-entry'));
                  const targetEntry = logEntries.find(entry => entry.textContent.includes(`${getFullDay(parseInt(round))}`));
                  if (targetEntry) {
                      targetEntry.scrollIntoView({ behavior: 'smooth', block: 'center' });
                      targetEntry.style.transition = 'background-color 0.3s';
                      targetEntry.style.backgroundColor = 'var(--c-gold)';
                      setTimeout(() => targetEntry.style.backgroundColor = '', 1500);
                  }
              }, 300);
          }
      });
      
      // Ind√≠t√°s
      populateChaosCards(); populateMarketCards(); initializeCharts(); loadPdfSectionPrefs(); resetTimer();
    });
  </script>
<p class="text-xs text-center text-slate-400 dark:text-slate-500 mt-8 pb-4">
    K√©sz√≠tette: Budai M√°t√©, 2025, mate.budai@gmail.com. Minden jog fenntartva! Hajr√°, Fradi!
  </p>
</body>
</html>
